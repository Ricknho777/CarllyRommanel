<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Administrador - Romanel Joias</title>
    <style>
        /* ========== RESET E ESTILOS GERAIS ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .admin-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ========== STATUS EM TEMPO REAL ========== */
        .real-time-status {
            display: none;
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px 20px;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .real-time-status.api-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }

        .real-time-status.api-warning {
            background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
        }

        .real-time-status.api-error {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }

        /* ========== CABE√áALHO ========== */
        .admin-header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .admin-header h1 {
            color: #2c3e50;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .admin-header p {
            color: #7f8c8d;
            font-size: 16px;
            margin-bottom: 25px;
        }

        /* ========== NAVEGA√á√ÉO ========== */
        .admin-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding-top: 20px;
            border-top: 2px solid #f1f1f1;
        }

        .admin-nav-btn {
            background: white;
            border: 2px solid #e0e0e0;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #555;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-nav-btn:hover {
            background: #f8f9fa;
            border-color: #007bff;
            color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
        }

        .admin-nav-btn.active {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border-color: #007bff;
        }

        .admin-nav-btn.btn-info {
            background: #17a2b8;
            border-color: #17a2b8;
            color: white;
        }

        .admin-nav-btn.btn-danger {
            background: #dc3545;
            border-color: #dc3545;
            color: white;
        }

        .admin-nav-btn.btn-success {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }

        .sync-badge {
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-left: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* ========== SE√á√ïES ========== */
        .admin-section {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .admin-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f1f1f1;
        }

        .section-header h2 {
            color: #2c3e50;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ========== STATUS DA API ========== */
        .api-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: fadeIn 0.5s ease;
        }

        .api-status.api-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .api-status.api-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .api-status.api-error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        /* ========== ESTAT√çSTICAS ========== */
        .section-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: #007bff;
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.15);
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ========== FORMUL√ÅRIOS ========== */
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 2px solid #e9ecef;
        }

        .form-section h3 {
            color: #495057;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .d-none {
            display: none !important;
        }

        /* ========== BOT√ïES ========== */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        .w-100 {
            width: 100%;
        }

        .mb-2 {
            margin-bottom: 10px;
        }

        .mb-3 {
            margin-bottom: 15px;
        }

        .mt-2 {
            margin-top: 10px;
        }

        .mt-3 {
            margin-top: 15px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* ========== FILTROS ========== */
        .filters-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-box input {
            flex: 3;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }

        .search-box select {
            flex: 1;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
        }

        .filter-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background: #f1f1f1;
        }

        .filter-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        /* ========== LISTA DE PRODUTOS ========== */
        #products-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .product-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border-color: #007bff;
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .product-info {
            padding: 20px;
        }

        .product-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .product-price {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
        }

        .gender-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .gender-feminino {
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            color: #721c24;
        }

        .gender-masculino {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            color: #0c5460;
        }

        .gender-unissex {
            background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
            color: #155724;
        }

        .gender-infantil {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: #004085;
        }

        /* ========== TABELAS ========== */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .admin-table thead {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }

        .admin-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .admin-table td {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            font-size: 14px;
        }

        .admin-table tbody tr:hover {
            background: #f8f9fa;
        }

        .admin-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* ========== BADGES DE STATUS ========== */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-received {
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            color: #721c24;
        }

        .status-approved {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: #155724;
        }

        .status-preparing {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            color: #0c5460;
        }

        .status-ready {
            background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
            color: #004085;
        }

        .status-shipped {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            color: #856404;
        }

        .status-delivered {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .status-cancelled {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }

        .refund-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .refund-pending {
            background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
            color: white;
        }

        .refund-approved {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .refund-rejected {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }

        .refund-processing {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
        }

        .refund-completed {
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
            color: white;
        }

        /* ========== MODAIS ========== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 2px solid #f1f1f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            color: #2c3e50;
            font-size: 20px;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            color: #6c757d;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: #dc3545;
        }

        /* ========== LOADING ========== */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loading-message {
            color: #495057;
            font-size: 18px;
            font-weight: 600;
        }

        /* ========== NOTIFICA√á√ïES ========== */
        .notifications-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .notification-item {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .notification-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .notification-item.new-notification {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #f8fff8 0%, #e8f5e8 100%);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .notification-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }

        .notification-date {
            color: #6c757d;
            font-size: 12px;
        }

        /* ========== UTILIT√ÅRIOS ========== */
        .text-center {
            text-align: center;
        }

        .text-muted {
            color: #6c757d !important;
        }

        .p-3 {
            padding: 15px;
        }

        .align-center {
            align-items: center;
        }

        .d-flex {
            display: flex;
        }

        .gap-3 {
            gap: 15px;
        }

        /* ========== RESPONSIVO ========== */
        @media (max-width: 768px) {
            .admin-nav {
                flex-direction: column;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .section-stats {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            #products-container {
                grid-template-columns: 1fr;
            }
            
            .admin-table {
                display: block;
                overflow-x: auto;
            }
        }

        /* ========== ESTILOS DO MODAL DE LOGIN ========== */
        #login-modal .modal-content {
            max-width: 400px;
            animation: slideUp 0.3s ease;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Status em tempo real -->
        <div id="real-time-status" class="real-time-status"></div>
        
        <!-- Cabe√ßalho -->
        <div class="admin-header">
            <h1>Painel de Administrador - Romanel Joias</h1>
            <p>Gerencie produtos, pedidos, reembolsos e muito mais</p>
            <div class="admin-nav">
                <button class="admin-nav-btn active" onclick="showSection('dashboard')">
                    üìä Dashboard
                </button>
                <button class="admin-nav-btn" onclick="showSection('products')">
                    üõçÔ∏è Produtos
                </button>
                <button class="admin-nav-btn" onclick="showSection('orders')">
                    üì¶ Pedidos
                </button>
                <button class="admin-nav-btn" onclick="showSection('refunds')">
                    üí∞ Reembolsos
                </button>
                <button class="admin-nav-btn" onclick="showSection('notifications')">
                    üîî Notifica√ß√µes
                </button>
                <button class="admin-nav-btn" onclick="showSection('settings')">
                    ‚öôÔ∏è Configura√ß√µes
                </button>
                <button class="admin-nav-btn btn-info sync-button" onclick="syncWithAPI()" id="sync-button">
                    üîÑ Sincronizar
                    <span class="sync-badge" id="sync-badge">!</span>
                </button>
                <button class="admin-nav-btn btn-danger" onclick="logout()">
                    üö™ Sair
                </button>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard-section" class="admin-section active">
            <div class="section-header">
                <h2>üìä Dashboard</h2>
                <span id="current-time"></span>
            </div>

            <!-- Status da API -->
            <div id="api-status-area" style="margin-bottom: 20px;">
                <div id="api-status" class="api-status"></div>
            </div>

            <div class="section-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-products">0</div>
                    <div class="stat-label">Produtos Cadastrados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-orders">0</div>
                    <div class="stat-label">Pedidos Totais</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pending-orders">0</div>
                    <div class="stat-label">Pedidos Pendentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pending-refunds">0</div>
                    <div class="stat-label">Reembolsos Pendentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-revenue">R$ 0,00</div>
                    <div class="stat-label">Receita Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="today-orders">0</div>
                    <div class="stat-label">Pedidos Hoje</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <h3>üìà Estat√≠sticas Recentes</h3>
                    <div id="recent-stats" class="p-3" style="background-color: #f8f9fa; border-radius: 6px;">
                        <p class="text-muted">Carregando estat√≠sticas...</p>
                    </div>
                </div>
                <div class="form-group" style="flex: 1;">
                    <h3>‚ö° A√ß√µes R√°pidas</h3>
                    <div class="action-buttons mt-3">
                        <button class="btn btn-success w-100 mb-2" onclick="showSection('products'); showAddProductForm();">
                            ‚ûï Adicionar Produto
                        </button>
                        <button class="btn btn-primary w-100 mb-2" onclick="showSection('orders')">
                            üìã Ver Pedidos
                        </button>
                        <button class="btn btn-warning w-100 mb-2" onclick="showSection('refunds')">
                            üí∞ Gerenciar Reembolsos
                        </button>
                        <button class="btn btn-info w-100 mb-2" onclick="exportData()">
                            üì§ Exportar Dados
                        </button>
                        <button class="btn btn-warning w-100" onclick="testIntegration()">
                            üß™ Testar Integra√ß√£o
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gerenciar Produtos -->
        <div id="products-section" class="admin-section">
            <div class="section-header">
                <h2>üõçÔ∏è Gerenciar Produtos</h2>
                <div class="d-flex align-center gap-3">
                    <button class="btn btn-info" onclick="syncWithAPI()">
                        üîÑ Sincronizar com API
                    </button>
                    <button class="btn btn-success" onclick="showAddProductForm()">
                        ‚ûï Novo Produto
                    </button>
                    <button class="btn btn-warning" onclick="checkProductSync()">
                        üîç Verificar Sincroniza√ß√£o
                    </button>
                </div>
            </div>

            <!-- Feedback de API -->
            <div id="product-api-feedback" style="margin-bottom: 15px;"></div>

            <div class="filters-container">
                <div class="search-box">
                    <input type="text" id="product-search" placeholder="Buscar produtos por nome, c√≥digo ou categoria..."
                           onkeyup="filterProducts()">
                    <select id="category-filter" onchange="filterProducts()">
                        <option value="">Todas as Categorias</option>
                        <option value="aneis">An√©is</option>
                        <option value="colares">Colares</option>
                        <option value="brincos">Brincos</option>
                        <option value="pulseiras">Pulseiras</option>
                        <option value="pingentes">Pingentes</option>
                        <option value="relogios">Rel√≥gios</option>
                        <option value="solitarios">Solit√°rios</option>
                        <option value="pet">Pet</option>
                        <option value="chaveiros">Chaveiros</option>
                        <option value="aliancas">Alian√ßas</option>
                        <option value="correntes">Correntes</option>
                        <option value="promocoes">Promo√ß√µes</option>
                    </select>
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="setProductFilter('all')">Todos</button>
                    <button class="filter-btn" onclick="setProductFilter('sale')">Em Promo√ß√£o</button>
                    <button class="filter-btn" onclick="setProductFilter('low-stock')">Estoque Baixo</button>
                </div>
            </div>

            <div id="add-product-form" class="form-section d-none">
                <h3>‚ûï Adicionar Novo Produto</h3>
                <div id="form-api-feedback" style="margin-bottom: 15px;"></div>
                <form id="product-form" onsubmit="saveProduct(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="product-name">Nome do Produto *</label>
                            <input type="text" id="product-name" required>
                        </div>
                        <div class="form-group">
                            <label for="product-code">C√≥digo *</label>
                            <input type="text" id="product-code" required>
                            <small class="text-muted">C√≥digo √∫nico para identificar o produto (ex: ROM001)</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="product-price">Pre√ßo (R$) *</label>
                            <input type="number" id="product-price" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="product-category">Categoria *</label>
                            <select id="product-category" required>
                                <option value="aneis">An√©is</option>
                                <option value="colares">Colares</option>
                                <option value="brincos">Brincos</option>
                                <option value="pulseiras">Pulseiras</option>
                                <option value="pingentes">Pingentes</option>
                                <option value="relogios">Rel√≥gios</option>
                                <option value="solitarios">Solit√°rios</option>
                                <option value="pet">Pet</option>
                                <option value="chaveiros">Chaveiros</option>
                                <option value="aliancas">Alian√ßas</option>
                                <option value="correntes">Correntes</option>
                                <option value="promocoes">Promo√ß√µes</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="product-color">Cor *</label>
                            <input type="text" id="product-color" list="color-options" required>
                            <datalist id="color-options">
                                <option value="Prata">
                                <option value="Dourado">
                                <option value="Rose">
                                <option value="Preto">
                                <option value="Colorido">
                                <option value="Branco">
                            </datalist>
                        </div>
                        <div class="form-group">
                            <label for="product-gender">G√™nero *</label>
                            <select id="product-gender" required>
                                <option value="feminino">Feminino</option>
                                <option value="masculino">Masculino</option>
                                <option value="infantil">Infantil</option>
                                <option value="unissex">Unissex</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="product-stock">Estoque *</label>
                            <input type="number" id="product-stock" value="10" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="product-sizes">Tamanhos (separados por v√≠rgula)</label>
                            <input type="text" id="product-sizes" placeholder="Ex: P, M, G, GG">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="product-image">URL da Imagem Principal *</label>
                        <input type="url" id="product-image" placeholder="https://exemplo.com/imagem.jpg" required>
                        <small class="text-muted">Use um link direto para a imagem (ex: Unsplash, Imgur, etc.)</small>
                    </div>

                    <div class="form-group">
                        <label for="product-description">Descri√ß√£o</label>
                        <textarea id="product-description" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="product-features">Caracter√≠sticas (uma por linha)</label>
                        <textarea id="product-features" rows="3" placeholder="Ouro 18k&#10;Diamante 0.5ct&#10;Garantia 2 anos"></textarea>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="product-on-sale" onchange="toggleSaleFields()">
                            Produto em Promo√ß√£o
                        </label>
                    </div>

                    <div id="sale-fields" class="d-none">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="original-price">Pre√ßo Original (R$)</label>
                                <input type="number" id="original-price" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="discount-percentage">Desconto (%)</label>
                                    <input type="number" id="discount-percentage" min="0" max="100">
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons mt-3">
                        <button type="submit" class="btn btn-success">üíæ Salvar Produto</button>
                        <button type="button" class="btn btn-danger" onclick="hideAddProductForm()">‚ùå Cancelar</button>
                        <button type="button" class="btn btn-info" onclick="testSaveProduct()">üß™ Testar API</button>
                    </div>
                </form>
            </div>

            <div id="products-list">
                <div id="products-container">
                    <!-- Produtos ser√£o carregados aqui -->
                </div>
            </div>
        </div>

        <!-- Gerenciar Pedidos -->
        <div id="orders-section" class="admin-section">
            <div class="section-header">
                <h2>üì¶ Gerenciar Pedidos</h2>
                <div class="d-flex align-center gap-3">
                    <select id="order-status-filter" onchange="filterOrders()">
                        <option value="">Todos os Status</option>
                        <option value="received">Recebido</option>
                        <option value="approved">Aprovado</option>
                        <option value="preparing">Preparando</option>
                        <option value="ready">Pronto</option>
                        <option value="shipped">Enviado</option>
                        <option value="delivered">Entregue</option>
                        <option value="cancelled">Cancelado</option>
                    </select>
                    <button class="btn btn-info" onclick="exportOrders()">üì§ Exportar</button>
                </div>
            </div>

            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Cliente</th>
                        <th>Itens</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Data</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="orders-table-body">
                    <!-- Pedidos ser√£o carregados aqui -->
                </tbody>
            </table>

            <div id="order-details-modal" class="modal-overlay">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">üìã Detalhes do Pedido</h3>
                        <button class="close-modal" onclick="closeOrderModal()">&times;</button>
                    </div>
                    <div id="order-details-content">
                        <!-- Detalhes do pedido ser√£o carregados aqui -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Gerenciar Reembolsos -->
        <div id="refunds-section" class="admin-section">
            <div class="section-header">
                <h2>üí∞ Gerenciar Reembolsos</h2>
                <div class="d-flex align-center gap-3">
                    <select id="refund-status-filter" onchange="filterRefunds()">
                        <option value="">Todos os Status</option>
                        <option value="pending">Pendente</option>
                        <option value="approved">Aprovado</option>
                        <option value="processing">Processando</option>
                        <option value="completed">Conclu√≠do</option>
                        <option value="rejected">Rejeitado</option>
                    </select>
                    <button class="btn btn-danger" onclick="cleanupRefunds()">üóëÔ∏è Limpar Conclu√≠dos</button>
                </div>
            </div>

            <div class="section-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-refunds">0</div>
                    <div class="stat-label">Total de Reembolsos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pending-refunds-count">0</div>
                    <div class="stat-label">Pendentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="approved-refunds">0</div>
                    <div class="stat-label">Aprovados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completed-refunds">0</div>
                    <div class="stat-label">Conclu√≠dos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="refunds-amount">R$ 0,00</div>
                    <div class="stat-label">Valor Total</div>
                </div>
            </div>

            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Pedido</th>
                        <th>Cliente</th>
                        <th>Motivo</th>
                        <th>Valor</th>
                        <th>Status</th>
                        <th>Solicitado em</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="refunds-table-body">
                    <!-- Reembolsos ser√£o carregados aqui -->
                </tbody>
            </table>
        </div>

        <!-- Notifica√ß√µes -->
        <div id="notifications-section" class="admin-section">
            <div class="section-header">
                <h2>üîî Notifica√ß√µes</h2>
                <div class="d-flex align-center gap-3">
                    <button class="btn btn-info" onclick="refreshNotifications()">üîÑ Atualizar</button>
                    <button class="btn btn-danger" onclick="clearAllNotifications()">üóëÔ∏è Limpar Todas</button>
                </div>
            </div>

            <div class="notifications-container">
                <div id="notifications-list">
                    <!-- Notifica√ß√µes ser√£o carregadas aqui -->
                </div>
            </div>
        </div>

        <!-- Configura√ß√µes -->
        <div id="settings-section" class="admin-section">
            <div class="section-header">
                <h2>‚öôÔ∏è Configura√ß√µes do Sistema</h2>
            </div>

            <div class="form-section">
                <h3>‚öôÔ∏è Configura√ß√µes Gerais</h3>
                <div class="form-group">
                    <label for="store-name">Nome da Loja</label>
                    <input type="text" id="store-name" value="Romanel Joias">
                </div>
                <div class="form-group">
                    <label for="store-email">E-mail de Contato</label>
                    <input type="email" id="store-email" value="contato@romaneljoias.com">
                </div>
                <div class="form-group">
                    <label for="store-phone">Telefone</label>
                    <input type="tel" id="store-phone" value="(11) 1234-5678">
                </div>
                <button class="btn btn-success" onclick="saveSettings()">üíæ Salvar Configura√ß√µes</button>
            </div>

            <div class="form-section">
                <h3>üóëÔ∏è Manuten√ß√£o do Sistema</h3>
                <p class="text-muted mb-3">Limpeza de dados antigos para manter o sistema organizado</p>
                <div class="action-buttons">
                    <button class="btn btn-warning" onclick="backupData()">üíæ Backup de Dados</button>
                    <button class="btn btn-danger" onclick="cleanupDeliveredOrders()">üóëÔ∏è Limpar Pedidos Entregues</button>
                    <button class="btn btn-danger" onclick="cleanupCancelledOrders()">üóëÔ∏è Limpar Pedidos Cancelados</button>
                    <button class="btn btn-danger" onclick="cleanupOldRefunds()">üóëÔ∏è Limpar Reembolsos Antigos</button>
                </div>
            </div>

            <div class="form-section">
                <h3>üîê Seguran√ßa</h3>
                <div class="form-group">
                    <label for="admin-password">Nova Senha de Administrador</label>
                    <input type="password" id="admin-password" placeholder="Digite nova senha">
                </div>
                <div class="form-group">
                    <label for="confirm-password">Confirmar Senha</label>
                    <input type="password" id="confirm-password" placeholder="Confirme a senha">
                </div>
                <button class="btn btn-danger" onclick="changePassword()">üîí Alterar Senha</button>
            </div>
        </div>

        <!-- Modal de Confirma√ß√£o -->
        <div id="confirmation-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="confirmation-title">Confirma√ß√£o</h3>
                    <button class="close-modal" onclick="closeConfirmationModal()">&times;</button>
                </div>
                <p id="confirmation-message"></p>
                <div class="action-buttons mt-3">
                    <button class="btn btn-success" id="confirm-action-btn">Confirmar</button>
                    <button class="btn btn-danger" onclick="closeConfirmationModal()">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loading-overlay">
            <div class="loading-spinner"></div>
            <p id="loading-message">Processando...</p>
        </div>
    </div>

    <script>
        // ========== VARI√ÅVEIS GLOBAIS ==========
        let products = [];
        let orders = [];
        let refunds = [];
        let notifications = [];
        let currentProductFilter = 'all';
        let currentOrderStatusFilter = '';
        let currentRefundStatusFilter = '';
        let unsavedChanges = false;
        let apiStatus = 'unknown';
        let currentAdminToken = null;

        // Status de reembolso
        const refundStatuses = {
            PENDING: 'pending',
            APPROVED: 'approved',
            REJECTED: 'rejected',
            PROCESSING: 'processing',
            COMPLETED: 'completed'
        };

        // Status de pedido
        const orderStatuses = [
            { key: 'received', label: 'Pedido Recebido', icon: 'üì•' },
            { key: 'approved', label: 'Pagamento Aprovado', icon: '‚úÖ' },
            { key: 'preparing', label: 'Preparando Pedido', icon: 'üîß' },
            { key: 'ready', label: 'Pronto para Entrega', icon: 'üì¶' },
            { key: 'shipped', label: 'Pedido Enviado', icon: 'üöö' },
            { key: 'delivered', label: 'Entregue', icon: 'üè†' },
            { key: 'cancelled', label: 'Cancelado', icon: '‚ùå' }
        ];

        // ========== INICIALIZA√á√ÉO ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîÑ Painel de Administrador - Inicializando...');
            
            // Primeiro verificar se h√° redirecionamento na URL
            if (checkRedirectInURL()) {
                return;
            }
            
            // Verificar autentica√ß√£o
            checkAdminAuthAndRedirect();
            
            // Verificar status da API
            checkApiStatus();
            
            // Carregar dados
            loadData();
            
            // Inicializar dashboard
            updateDashboard();
            
            // Atualizar hora atual
            updateCurrentTime();
            setInterval(updateCurrentTime, 60000);
            
            // Verificar altera√ß√µes n√£o salvas a cada 10 segundos
            setInterval(checkUnsavedChanges, 10000);
            
            // Adicionar listener para antes de sair da p√°gina
            window.addEventListener('beforeunload', function(e) {
                if (unsavedChanges) {
                    e.preventDefault();
                    e.returnValue = 'Voc√™ tem altera√ß√µes n√£o salvas. Tem certeza que deseja sair?';
                }
            });
            
            // Adicionar bot√£o de teste
            setTimeout(addTestButton, 1000);
        });

        // ========== VERIFICA√á√ÉO DE AUTENTICA√á√ÉO E REDIRECIONAMENTO ==========
        function checkAdminAuthAndRedirect() {
            const adminToken = localStorage.getItem('adminToken');
            const tokenExpiry = localStorage.getItem('adminTokenExpiry');
            const currentTime = new Date().getTime();
            
            // Verificar se h√° um token v√°lido
            if (adminToken && tokenExpiry && currentTime < parseInt(tokenExpiry)) {
                currentAdminToken = adminToken;
                console.log('‚úÖ Admin autenticado via token');
                
                // Se j√° estiver na p√°gina admin, n√£o fazer nada
                if (window.location.pathname.includes('/admin')) {
                    return true;
                }
                
                return true;
            } else {
                // Token inv√°lido ou expirado, mostrar modal de login
                showLoginModal();
                return false;
            }
        }

        // ========== FUN√á√ÉO DE REDIRECIONAMENTO AP√ìS LOGIN ==========
        function handleLoginRedirect(redirectUrl) {
            console.log('üîÄ Tentando redirecionar para:', redirectUrl);
            
            if (redirectUrl) {
                // Se a URL contiver token, process√°-lo primeiro
                if (redirectUrl.includes('/admin/redirect?token=')) {
                    const urlObj = new URL(redirectUrl, window.location.origin);
                    const token = urlObj.searchParams.get('token');
                    
                    if (token) {
                        // Salvar token no localStorage
                        localStorage.setItem('adminToken', token);
                        const expiryTime = new Date().getTime() + (24 * 60 * 60 * 1000); // 24 horas
                        localStorage.setItem('adminTokenExpiry', expiryTime.toString());
                        currentAdminToken = token;
                        
                        console.log('üîë Token salvo no localStorage');
                    }
                }
                
                // Aguardar um momento e redirecionar
                setTimeout(() => {
                    console.log('üîÑ Redirecionando para:', redirectUrl);
                    window.location.href = redirectUrl;
                }, 500);
            }
        }

        // ========== VERIFICA√á√ÉO DE REDIRECIONAMENTO NA URL ==========
        function checkRedirectInURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const redirectUrl = urlParams.get('redirect');
            
            if (redirectUrl && redirectUrl.includes('/admin')) {
                console.log('üîÄ Redirecionamento detectado na URL:', redirectUrl);
                handleLoginRedirect(redirectUrl);
                return true;
            }
            return false;
        }

        // ========== VERIFICA√á√ÉO DE API ==========
        async function checkApiStatus() {
            try {
                console.log('üîç Verificando status da API...');
                
                // Testar API p√∫blica
                const publicResponse = await fetch('/api/produtos');
                const publicStatus = publicResponse.ok;
                
                // Testar API admin
                const adminResponse = await fetch('/api/admin/products', {
                    headers: getAuthHeaders()
                });
                const adminStatus = adminResponse.ok;
                
                if (publicStatus && adminStatus) {
                    apiStatus = 'online';
                    showApiStatus('‚úÖ API online e funcionando', 'api-success');
                    document.getElementById('sync-badge').style.display = 'none';
                } else {
                    apiStatus = 'partial';
                    showApiStatus('‚ö†Ô∏è API parcialmente dispon√≠vel', 'api-warning');
                    document.getElementById('sync-badge').style.display = 'flex';
                }
                
                return apiStatus;
            } catch (error) {
                apiStatus = 'offline';
                showApiStatus('‚ùå API offline - Verifique o servidor Flask', 'api-error');
                document.getElementById('sync-badge').style.display = 'flex';
                return apiStatus;
            }
        }

        function showApiStatus(message, type) {
            const statusArea = document.getElementById('api-status');
            if (statusArea) {
                statusArea.textContent = message;
                statusArea.className = `api-status ${type}`;
                statusArea.style.display = 'block';
                
                // Atualizar status em tempo real
                showRealTimeStatus(message, type);
            }
        }

        function showRealTimeStatus(message, type) {
            const statusDiv = document.getElementById('real-time-status');
            if (statusDiv) {
                statusDiv.textContent = `üîÑ ${message}`;
                statusDiv.className = `real-time-status ${type}`;
                statusDiv.style.display = 'block';
                
                // Esconder ap√≥s 5 segundos
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // ========== AUTENTICA√á√ÉO (CORRIGIDA) ==========
        function checkAdminAuth() {
            const adminToken = localStorage.getItem('adminToken');
            const tokenExpiry = localStorage.getItem('adminTokenExpiry');
            const currentTime = new Date().getTime();
            
            // Verificar se h√° um token v√°lido
            if (adminToken && tokenExpiry && currentTime < parseInt(tokenExpiry)) {
                currentAdminToken = adminToken;
                console.log('‚úÖ Admin autenticado via token');
                return true;
            } else {
                // Token inv√°lido ou expirado, mostrar modal de login
                showLoginModal();
                return false;
            }
        }

        function getAuthHeaders() {
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (currentAdminToken) {
                headers['Authorization'] = `Bearer ${currentAdminToken}`;
            }
            
            return headers;
        }

        function showLoginModal() {
            // Criar modal de login
            const loginModal = document.createElement('div');
            loginModal.id = 'login-modal';
            loginModal.className = 'modal-overlay';
            loginModal.style.display = 'flex';
            loginModal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3 class="modal-title">üîê Acesso Administrativo</h3>
                    </div>
                    <div style="padding: 20px;">
                        <div class="form-group">
                            <label for="admin-email">E-mail</label>
                            <input type="email" id="admin-email" class="form-control" placeholder="admin@romaneljoias.com" autocomplete="email">
                        </div>
                        <div class="form-group">
                            <label for="admin-password-login">Senha</label>
                            <input type="password" id="admin-password-login" class="form-control" placeholder="Digite sua senha" autocomplete="current-password">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="remember-me" checked>
                                Lembrar-me
                            </label>
                        </div>
                        <div id="login-feedback" style="margin: 10px 0;"></div>
                        <div class="action-buttons mt-3">
                            <button class="btn btn-success" onclick="performAdminLogin()" style="width: 100%;">
                                üîë Entrar
                            </button>
                            <button class="btn btn-danger" onclick="redirectToHome()" style="width: 100%; margin-top: 10px;">
                                üè† Voltar ao Site
                            </button>
                        </div>
                        <p class="text-muted mt-3" style="font-size: 12px; text-align: center;">
                            Sistema compat√≠vel com senha em texto ou hash SHA256<br>
                            Acesso restrito aos administradores do sistema.
                        </p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(loginModal);
            
            // Adicionar evento para tecla Enter
            document.getElementById('admin-password-login').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performAdminLogin();
                }
            });
        }

        async function performAdminLogin() {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password-login').value;
            const rememberMe = document.getElementById('remember-me').checked;
            const feedbackDiv = document.getElementById('login-feedback');
            
            console.log('üîë Tentando login com email:', email);
            
            if (!email || !password) {
                showLoginFeedback('‚ùå Por favor, preencha todos os campos.', 'error');
                return;
            }
            
            // Validar formato de e-mail
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showLoginFeedback('‚ùå Por favor, insira um e-mail v√°lido.', 'error');
                return;
            }
            
            showLoading('üîê Verificando credenciais...');
            
            try {
                // TENTAR LOGIN UNIFICADO PRIMEIRO
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email.trim(),
                        password: password,
                        // Nota: o campo 'senha' tamb√©m funciona para compatibilidade
                    })
                });
                
                console.log('üîë Status da resposta:', response.status);
                
                if (!response.ok) {
                    // Se for 401, tentar rota espec√≠fica de admin como fallback
                    if (response.status === 401) {
                        console.log('üîÑ Tentando rota espec√≠fica de admin como fallback...');
                        const adminResponse = await fetch('/api/admin/login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                email: email.trim(),
                                password: password,
                                rememberMe: rememberMe
                            })
                        });
                        
                        if (!adminResponse.ok) {
                            throw new Error('E-mail ou senha incorretos');
                        }
                        
                        const result = await adminResponse.json();
                        processLoginResult(result, email, rememberMe);
                        return;
                    }
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('üîë Resposta da API:', result);
                
                // Verificar se √© login de admin
                if (result.success && result.user && result.user.role === 'admin') {
                    processLoginResult(result, email, rememberMe);
                } else if (result.success) {
                    // √â um usu√°rio comum, mas estamos no painel admin
                    hideLoading();
                    showLoginFeedback('‚ùå Este √© um usu√°rio comum. Apenas administradores podem acessar o painel.', 'error');
                    // Limpar campo de senha
                    document.getElementById('admin-password-login').value = '';
                } else {
                    hideLoading();
                    showLoginFeedback(`‚ùå ${result.error || 'E-mail ou senha incorretos. Tente novamente.'}`, 'error');
                    // Limpar campo de senha
                    document.getElementById('admin-password-login').value = '';
                }
            } catch (error) {
                hideLoading();
                console.error('‚ùå Erro no login:', error);
                
                // Mensagem de erro mais amig√°vel
                let errorMessage = '‚ùå Erro ao conectar ao servidor';
                if (error.message.includes('E-mail ou senha incorretos')) {
                    errorMessage = '‚ùå E-mail ou senha incorretos. Verifique suas credenciais.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = '‚ùå N√£o foi poss√≠vel conectar ao servidor. Verifique se o servidor Flask est√° rodando.';
                }
                
                showLoginFeedback(errorMessage, 'error');
                
                // Limpar campo de senha
                document.getElementById('admin-password-login').value = '';
            }
        }

        function processLoginResult(result, email, rememberMe) {
            // Login bem-sucedido
            const token = result.token;
            const expiryTime = new Date().getTime() + (rememberMe ? 7 * 24 * 60 * 60 * 1000 : 24 * 60 * 60 * 1000);
            
            // Salvar token
            currentAdminToken = token;
            localStorage.setItem('adminToken', token);
            localStorage.setItem('adminTokenExpiry', expiryTime.toString());
            localStorage.setItem('adminEmail', email);
            
            // Remover modal
            const loginModal = document.getElementById('login-modal');
            if (loginModal) {
                loginModal.remove();
            }
            
            hideLoading();
            showAlert(`‚úÖ Bem-vindo, ${email}! Login realizado com sucesso.`, 'success');
            console.log('‚úÖ Login administrativo realizado com sucesso');
            
            // **CORRE√á√ÉO CR√çTICA**: Redirecionar automaticamente
            if (result.redirect_url) {
                console.log('üîÄ Redirecionando para:', result.redirect_url);
                // For√ßar redirecionamento
                setTimeout(() => {
                    window.location.href = result.redirect_url;
                }, 100);
            } else if (result.user && result.user.role === 'admin') {
                console.log('üîÄ Redirecionando para /admin (fallback)');
                setTimeout(() => {
                    window.location.href = '/admin';
                }, 100);
            } else {
                console.log('‚ö†Ô∏è Nenhuma URL de redirecionamento fornecida');
            }
        }

        function showLoginFeedback(message, type) {
            const feedbackDiv = document.getElementById('login-feedback');
            if (feedbackDiv) {
                feedbackDiv.innerHTML = `
                    <div style="padding: 10px; border-radius: 4px; background-color: ${type === 'error' ? '#f8d7da' : '#d4edda'}; color: ${type === 'error' ? '#721c24' : '#155724'};">
                        ${message}
                    </div>
                `;
            }
        }

        function logout() {
            showConfirmation(
                'Sair do Painel',
                'Tem certeza que deseja sair do painel de administrador?',
                async function() {
                    // Se houver token, invalidar no servidor
                    if (currentAdminToken) {
                        try {
                            await fetch('/api/admin/logout', {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${currentAdminToken}`,
                                    'Content-Type': 'application/json'
                                }
                            });
                        } catch (error) {
                            console.log('‚ö†Ô∏è Erro ao invalidar token no servidor:', error);
                        }
                    }
                    
                    // Limpar dados de sess√£o
                    localStorage.removeItem('adminToken');
                    localStorage.removeItem('adminTokenExpiry');
                    localStorage.removeItem('adminEmail');
                    currentAdminToken = null;
                    
                    // Redirecionar para a p√°gina principal
                    window.location.href = '/';
                }
            );
        }

        function redirectToHome() {
            window.location.href = '/';
        }

        function checkAdminAuthInFunction() {
            if (!currentAdminToken) {
                showAlert('‚ùå Acesso n√£o autorizado. Fa√ßa login novamente.', 'danger');
                showLoginModal();
                return false;
            }
            return true;
        }

        // ========== FUN√á√ÉO AUXILIAR PARA TESTE ==========
        function testAdminRedirect() {
            console.log('üß™ Testando redirecionamento admin...');
            
            // Simular um login bem-sucedido
            const testToken = 'test-token-' + Date.now();
            localStorage.setItem('adminToken', testToken);
            localStorage.setItem('adminTokenExpiry', (new Date().getTime() + 3600000).toString());
            
            // Redirecionar para admin
            window.location.href = '/admin/redirect?token=' + testToken;
        }

        // ========== ADICIONAR BOT√ÉO DE TESTE NO DASHBOARD ==========
        function addTestButton() {
            const dashboardSection = document.getElementById('dashboard-section');
            if (dashboardSection) {
                const testButton = document.createElement('button');
                testButton.className = 'btn btn-warning mt-3';
                testButton.innerHTML = 'üß™ Testar Redirecionamento';
                testButton.onclick = testAdminRedirect;
                
                const quickActions = dashboardSection.querySelector('.action-buttons');
                if (quickActions) {
                    quickActions.appendChild(testButton);
                }
            }
        }

        // ========== COMUNICA√á√ÉO COM API ==========
        async function syncWithAPI() {
            if (!checkAdminAuthInFunction()) return;
            
            showLoading('üîÑ Sincronizando com a API...');
            
            try {
                // Primeiro verifica status da API
                await checkApiStatus();
                
                if (apiStatus === 'offline') {
                    hideLoading();
                    showAlert('‚ùå N√£o foi poss√≠vel sincronizar. API offline.', 'danger');
                    return;
                }
                
                // Carrega produtos da API Flask
                await fetchProductsFromAPI();
                
                // Sincroniza produtos locais com a API
                await syncLocalProductsWithAPI();
                
                hideLoading();
                showAlert('‚úÖ Sincroniza√ß√£o conclu√≠da com sucesso!', 'success');
                
                // For√ßar atualiza√ß√£o do site principal
                await forceSiteUpdate();
                
            } catch (error) {
                console.error('‚ùå Erro na sincroniza√ß√£o:', error);
                hideLoading();
                showAlert('‚ùå Erro na sincroniza√ß√£o: ' + error.message, 'danger');
            }
        }

        async function fetchProductsFromAPI() {
            try {
                console.log('üì¶ Carregando produtos da API...');
                
                const response = await fetch('/api/admin/products', {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        console.log('‚ùå Token inv√°lido, mostrando modal de login');
                        showLoginModal();
                        return false;
                    }
                    throw new Error(`API retornou status ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.products) {
                    // Atualizar produtos locais com dados da API
                    products = result.products;
                    localStorage.setItem('romanelProducts', JSON.stringify(products));
                    
                    console.log(`‚úÖ Carregados ${products.length} produtos da API`);
                    
                    // Log detalhado
                    console.log('üìã Lista de produtos carregados:');
                    products.forEach((p, i) => {
                        console.log(`   ${i+1}. ${p.name} (ID: ${p.id}, C√≥d: ${p.code}) - R$ ${p.price}`);
                    });
                    
                    renderProducts();
                    updateDashboard();
                    
                    return true;
                } else {
                    console.error('‚ùå API retornou erro:', result.error);
                    return false;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è N√£o foi poss√≠vel carregar produtos da API:', error);
                // Fallback: carregar do localStorage
                const storedProducts = localStorage.getItem('romanelProducts');
                if (storedProducts) {
                    products = JSON.parse(storedProducts);
                    console.log(`üì¶ Carregados ${products.length} produtos do localStorage como fallback`);
                    renderProducts();
                    updateDashboard();
                }
                return false;
            }
        }

        async function syncLocalProductsWithAPI() {
            try {
                console.log('üîÑ Sincronizando produtos locais com a API...');
                
                const localProducts = JSON.parse(localStorage.getItem('romanelProducts') || '[]');
                const apiProducts = await getApiProducts();
                
                // Encontrar produtos que existem localmente mas n√£o na API
                const productsToSync = localProducts.filter(localProduct => {
                    return !apiProducts.some(apiProduct => apiProduct.code === localProduct.code);
                });
                
                if (productsToSync.length > 0) {
                    console.log(`üì§ Enviando ${productsToSync.length} produtos para a API...`);
                    
                    for (const product of productsToSync) {
                        await saveProductToAPI(product);
                    }
                    
                    console.log('‚úÖ Produtos sincronizados com a API');
                } else {
                    console.log('‚úÖ Todos os produtos j√° est√£o sincronizados com a API');
                }
                
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao sincronizar produtos:', error);
                return false;
            }
        }

        async function getApiProducts() {
            try {
                const response = await fetch('/api/admin/products', {
                    headers: getAuthHeaders()
                });
                const result = await response.json();
                return result.success ? result.products : [];
            } catch (error) {
                console.error('‚ùå Erro ao obter produtos da API:', error);
                return [];
            }
        }

        async function saveProductToAPI(productData) {
            try {
                console.log('üì§ Enviando produto para API:', productData.name);
                
                const response = await fetch('/api/admin/products', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(productData)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ Produto salvo na API:', result);
                    showFormFeedback('‚úÖ Produto salvo com sucesso na API!', 'success');
                    return result;
                } else {
                    console.error('‚ùå Erro ao salvar produto na API:', result.error);
                    showFormFeedback(`‚ùå Erro: ${result.error}`, 'error');
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Erro na requisi√ß√£o:', error);
                showFormFeedback(`‚ùå Erro de conex√£o: ${error.message}`, 'error');
                return null;
            }
        }

        async function updateProductInAPI(productId, productData) {
            try {
                console.log('üì§ Atualizando produto na API:', productId);
                
                const response = await fetch('/api/admin/products', {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        id: productId,
                        ...productData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ Produto atualizado na API:', result);
                    return result;
                } else {
                    console.error('‚ùå Erro ao atualizar produto na API:', result.error);
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Erro na requisi√ß√£o:', error);
                return null;
            }
        }

        async function deleteProductFromAPI(productId) {
            try {
                console.log('üì§ Removendo produto da API:', productId);
                
                const response = await fetch('/api/admin/products', {
                    method: 'DELETE',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({id: productId})
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ Produto removido da API:', result);
                    return result;
                } else {
                    console.error('‚ùå Erro ao remover produto da API:', result.error);
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Erro na requisi√ß√£o:', error);
                return null;
            }
        }

        // ========== FUN√á√ïES DE TESTE ==========
        async function testSaveProduct() {
            if (!checkAdminAuthInFunction()) return;
            
            console.log('üß™ Testando salvamento de produto...');
            
            const testProduct = {
                name: "Produto Teste " + Date.now(),
                code: "TEST" + Date.now(),
                price: 99.99,
                category: "aneis",
                color: "Prata",
                gender: "feminino",
                image: "https://via.placeholder.com/300x300?text=Produto+Teste",
                description: "Produto de teste",
                stock: 10,
                onSale: false
            };
            
            showLoading('üß™ Testando API...');
            
            try {
                const result = await saveProductToAPI(testProduct);
                
                if (result && result.success) {
                    showAlert('‚úÖ Teste de API bem-sucedido! Produto salvo.', 'success');
                    
                    // Atualizar lista de produtos
                    await fetchProductsFromAPI();
                    
                    // Verificar se o produto est√° na API p√∫blica
                    setTimeout(async () => {
                        await verifyProductInPublicAPI(testProduct.code);
                    }, 1000);
                } else {
                    showAlert('‚ùå Teste de API falhou. Verifique o servidor.', 'danger');
                }
            } catch (error) {
                showAlert('‚ùå Erro no teste: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }

        async function verifyProductInPublicAPI(productCode) {
            try {
                console.log(`üîç Verificando produto ${productCode} na API p√∫blica...`);
                
                const response = await fetch('/api/produtos');
                const publicProducts = await response.json();
                
                const foundProduct = publicProducts.find(p => p.code === productCode);
                
                if (foundProduct) {
                    showAlert(`‚úÖ SUCESSO! Produto ${productCode} est√° dispon√≠vel na loja!`, 'success');
                    console.log('‚úÖ Produto encontrado na API p√∫blica:', foundProduct);
                } else {
                    showAlert(`‚ö†Ô∏è Produto salvo mas N√ÉO encontrado na API p√∫blica. Recarregue a p√°gina da loja.`, 'warning');
                    console.warn('‚ö†Ô∏è Produto n√£o encontrado na API p√∫blica');
                }
            } catch (error) {
                console.error('‚ùå Erro ao verificar API p√∫blica:', error);
            }
        }

        async function testIntegration() {
            if (!checkAdminAuthInFunction()) return;
            
            console.log('üß™ Iniciando teste completo de integra√ß√£o...');
            
            showLoading('üß™ Testando integra√ß√£o...');
            
            try {
                // 1. Testar API p√∫blica
                const publicResponse = await fetch('/api/produtos');
                const publicProducts = await publicResponse.json();
                
                // 2. Testar API admin
                const adminResponse = await fetch('/api/admin/products', {
                    headers: getAuthHeaders()
                });
                const adminResult = await adminResponse.json();
                
                // 3. Verificar status
                const publicCount = Array.isArray(publicProducts) ? publicProducts.length : 0;
                const adminCount = adminResult.success ? (adminResult.products?.length || 0) : 0;
                
                let results = `
üß™ RESULTADO DOS TESTES:

‚úÖ API P√∫blica (/api/produtos): ${publicCount} produtos
‚úÖ API Admin (/api/admin/products): ${adminCount} produtos
${publicCount === adminCount ? '‚úÖ SINCRONIZA√á√ÉO: PERFEITA' : '‚ö†Ô∏è SINCRONIZA√á√ÉO: DIFEREN√áA ENCONTRADA'}

üìä Status do sistema:
‚Ä¢ Servidor Flask: ${publicResponse.ok ? '‚úÖ ONLINE' : '‚ùå OFFLINE'}
‚Ä¢ API Admin: ${adminResponse.ok ? '‚úÖ ONLINE' : '‚ùå OFFLINE'}
‚Ä¢ Produtos sincronizados: ${publicCount === adminCount ? '‚úÖ SIM' : '‚ùå N√ÉO'}
                `;
                
                hideLoading();
                
                if (publicCount === 0 && adminCount === 0) {
                    results += '\n\n‚ö†Ô∏è ATEN√á√ÉO: Nenhum produto encontrado no sistema!';
                }
                
                alert(results);
                
                // Mostrar detalhes no console
                console.log('üìã Produtos na API p√∫blica:', publicProducts);
                console.log('üìã Produtos na API admin:', adminResult.products);
                
            } catch (error) {
                hideLoading();
                showAlert('‚ùå Erro nos testes: ' + error.message, 'danger');
                console.error('‚ùå Erro nos testes:', error);
            }
        }

        async function checkProductSync() {
            if (!checkAdminAuthInFunction()) return;
            
            showLoading('üîç Verificando sincroniza√ß√£o...');
            
            try {
                const publicResponse = await fetch('/api/produtos');
                const publicProducts = await publicResponse.json();
                
                const adminResponse = await fetch('/api/admin/products', {
                    headers: getAuthHeaders()
                });
                const adminResult = await adminResponse.json();
                
                const publicCount = Array.isArray(publicProducts) ? publicProducts.length : 0;
                const adminCount = adminResult.success ? (adminResult.products?.length || 0) : 0;
                
                let syncMessage = '';
                
                if (publicCount === adminCount) {
                    syncMessage = `‚úÖ Sincroniza√ß√£o perfeita! ${publicCount} produtos em ambos os lados.`;
                    showAlert(syncMessage, 'success');
                } else {
                    syncMessage = `‚ö†Ô∏è Diferen√ßa encontrada! API P√∫blica: ${publicCount}, API Admin: ${adminCount}`;
                    showAlert(syncMessage, 'warning');
                    
                    // Sugerir corre√ß√£o
                    const fix = confirm(`${syncMessage}\n\nDeseja sincronizar agora?`);
                    if (fix) {
                        await syncWithAPI();
                    }
                }
                
                hideLoading();
                
            } catch (error) {
                hideLoading();
                showAlert('‚ùå Erro ao verificar sincroniza√ß√£o: ' + error.message, 'danger');
            }
        }

        // ========== FUN√á√ÉO PRINCIPAL DE SALVAR PRODUTO ==========
        async function saveProduct(e) {
            e.preventDefault();
            
            if (!checkAdminAuthInFunction()) return;
            
            showLoading('üíæ Salvando produto...');
            
            try {
                // 1. Coletar dados do formul√°rio
                const formData = collectProductFormData();
                
                // 2. Validar dados
                if (!validateProductForm(formData)) {
                    hideLoading();
                    return;
                }
                
                // 3. Enviar para API Flask
                console.log('üì§ Enviando produto para API Flask:', formData);
                const apiResult = await saveProductToAPI(formData);
                
                if (apiResult && apiResult.success) {
                    console.log('‚úÖ Produto salvo na API com ID:', apiResult.id);
                    
                    // 4. Atualizar localmente
                    const newProduct = {
                        ...formData,
                        id: apiResult.id || formData.id,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    // Adicionar √† lista local
                    const existingIndex = products.findIndex(p => p.id === newProduct.id);
                    if (existingIndex >= 0) {
                        products[existingIndex] = newProduct;
                    } else {
                        products.push(newProduct);
                    }
                    
                    // 5. Salvar no localStorage
                    localStorage.setItem('romanelProducts', JSON.stringify(products));
                    
                    // 6. Atualizar interface
                    hideAddProductForm();
                    renderProducts();
                    updateDashboard();
                    
                    // 7. Verificar na API p√∫blica
                    setTimeout(async () => {
                        await verifyProductInPublicAPI(newProduct.code);
                    }, 1500);
                    
                    // 8. Mostrar sucesso
                    hideLoading();
                    showAlert('‚úÖ Produto salvo com sucesso!', 'success');
                    
                    // 9. Sugerir verifica√ß√£o no site
                    setTimeout(() => {
                        const verify = confirm('Produto salvo com sucesso!\n\nDeseja abrir o site principal para verificar?');
                        if (verify) {
                            window.open('/', '_blank');
                        }
                    }, 1000);
                    
                } else {
                    hideLoading();
                    showAlert('‚ùå Erro ao salvar produto na API. Verifique o servidor Flask.', 'danger');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar produto:', error);
                hideLoading();
                showAlert('‚ùå Erro ao salvar produto: ' + error.message, 'danger');
            }
        }

        function collectProductFormData() {
            const isOnSale = document.getElementById('product-on-sale').checked;
            
            // Calcular pre√ßos
            let price = parseFloat(document.getElementById('product-price').value);
            let originalPrice = price;
            let discountPercentage = 0;
            
            if (isOnSale) {
                originalPrice = parseFloat(document.getElementById('original-price').value) || price;
                discountPercentage = parseFloat(document.getElementById('discount-percentage').value) || 0;
                
                if (discountPercentage > 0) {
                    price = originalPrice - (originalPrice * (discountPercentage / 100));
                } else if (originalPrice > price) {
                    discountPercentage = Math.round(((originalPrice - price) / originalPrice) * 100);
                }
            }
            
            // Processar tamanhos
            const sizesInput = document.getElementById('product-sizes').value;
            const sizes = sizesInput.trim() !== '' ? 
                sizesInput.split(',').map(s => ({ 
                    size: s.trim(), 
                    available: true 
                })) : 
                [{ size: "√önico", available: true }];
            
            // Processar caracter√≠sticas
            const featuresInput = document.getElementById('product-features').value;
            const features = featuresInput.trim() !== '' ? 
                featuresInput.split('\n').map(f => f.trim()).filter(f => f !== '') : 
                [];
            
            // Gerar ID (ser√° substitu√≠do pelo ID da API se houver sucesso)
            const productId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
            
            return {
                id: productId,
                code: document.getElementById('product-code').value,
                name: document.getElementById('product-name').value,
                price: price,
                originalPrice: originalPrice,
                discountPercentage: discountPercentage,
                onSale: isOnSale,
                category: document.getElementById('product-category').value,
                gender: document.getElementById('product-gender').value,
                color: document.getElementById('product-color').value,
                stock: parseInt(document.getElementById('product-stock').value) || 0,
                sizes: sizes,
                image: document.getElementById('product-image').value,
                description: document.getElementById('product-description').value,
                features: features,
                additionalImages: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
        }

        function validateProductForm(formData) {
            // Validar campos obrigat√≥rios
            const requiredFields = [
                { field: formData.name, name: 'Nome do Produto' },
                { field: formData.code, name: 'C√≥digo' },
                { field: formData.price, name: 'Pre√ßo' },
                { field: formData.category, name: 'Categoria' },
                { field: formData.image, name: 'URL da Imagem' }
            ];
            
            for (const req of requiredFields) {
                if (!req.field || req.field.toString().trim() === '') {
                    showFormFeedback(`‚ùå Campo obrigat√≥rio: ${req.name}`, 'error');
                    return false;
                }
            }
            
            // Validar pre√ßo
            if (formData.price <= 0) {
                showFormFeedback('‚ùå Pre√ßo deve ser maior que zero', 'error');
                return false;
            }
            
            // Validar URL da imagem
            try {
                new URL(formData.image);
            } catch (e) {
                showFormFeedback('‚ùå URL da imagem inv√°lida', 'error');
                return false;
            }
            
            return true;
        }

        function showFormFeedback(message, type) {
            const feedbackDiv = document.getElementById('form-api-feedback');
            if (feedbackDiv) {
                feedbackDiv.innerHTML = `
                    <div class="api-status api-${type === 'error' ? 'error' : 'success'}">
                        ${message}
                    </div>
                `;
                
                // Limpar ap√≥s 5 segundos
                setTimeout(() => {
                    feedbackDiv.innerHTML = '';
                }, 5000);
            }
        }

        // ========== FUN√á√ÉO ATUALIZAR PRODUTO ==========
        async function updateProduct(productId) {
            if (!checkAdminAuthInFunction()) return;
            
            showLoading('‚úèÔ∏è Atualizando produto...');
            
            try {
                const productIndex = products.findIndex(p => p.id === productId);
                if (productIndex === -1) throw new Error('Produto n√£o encontrado');
                
                // Coletar dados do formul√°rio
                const updatedData = collectProductFormData();
                updatedData.id = productId; // Manter o ID original
                
                // Atualizar na API Flask
                const apiResult = await updateProductInAPI(productId, updatedData);
                
                if (apiResult && apiResult.success) {
                    console.log('‚úÖ Produto atualizado na API');
                    
                    // Atualizar localmente
                    products[productIndex] = {
                        ...products[productIndex],
                        ...updatedData,
                        updatedAt: new Date().toISOString()
                    };
                    
                    // Salvar no localStorage
                    localStorage.setItem('romanelProducts', JSON.stringify(products));
                    
                    // Atualizar interface
                    hideAddProductForm();
                    renderProducts();
                    updateDashboard();
                    
                    // Verificar na API p√∫blica
                    setTimeout(async () => {
                        await verifyProductInPublicAPI(updatedData.code);
                    }, 1500);
                    
                    hideLoading();
                    showAlert('‚úÖ Produto atualizado com sucesso!', 'success');
                    
                } else {
                    hideLoading();
                    showAlert('‚ùå Erro ao atualizar produto na API', 'danger');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao atualizar produto:', error);
                hideLoading();
                showAlert('‚ùå Erro ao atualizar produto: ' + error.message, 'danger');
            }
        }

        // ========== FUN√á√ÉO EXCLUIR PRODUTO ==========
        async function deleteProduct(productId) {
            if (!checkAdminAuthInFunction()) return;
            
            showConfirmation(
                'Excluir Produto',
                'Tem certeza que deseja excluir este produto? Esta a√ß√£o n√£o pode ser desfeita.',
                async function() {
                    showLoading('üóëÔ∏è Excluindo produto...');
                    
                    try {
                        const product = products.find(p => p.id === productId);
                        if (!product) {
                            hideLoading();
                            showAlert('Produto n√£o encontrado', 'danger');
                            return;
                        }
                        
                        // Remover da API Flask
                        const apiResult = await deleteProductFromAPI(productId);
                        
                        // Remover localmente (independente do resultado da API)
                        products = products.filter(p => p.id !== productId);
                        localStorage.setItem('romanelProducts', JSON.stringify(products));
                        
                        // Atualizar interface
                        renderProducts();
                        updateDashboard();
                        
                        hideLoading();
                        
                        if (apiResult && apiResult.success) {
                            showAlert('‚úÖ Produto exclu√≠do com sucesso!', 'success');
                        } else {
                            showAlert('‚ö†Ô∏è Produto removido localmente, mas pode ainda existir na API', 'warning');
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Erro ao excluir produto:', error);
                        hideLoading();
                        showAlert('‚ùå Erro ao excluir produto: ' + error.message, 'danger');
                    }
                }
            );
        }

        // ========== FUN√á√ÉO FOR√áAR ATUALIZA√á√ÉO DO SITE ==========
        async function forceSiteUpdate() {
            try {
                console.log('üîÑ For√ßando atualiza√ß√£o do site principal...');
                
                // Recarregar produtos da API p√∫blica
                const publicResponse = await fetch('/api/produtos');
                const publicProducts = await publicResponse.json();
                
                console.log(`üì¶ Produtos na API p√∫blica: ${publicProducts.length}`);
                
                if (publicProducts.length > 0) {
                    showRealTimeStatus(`‚úÖ Site principal atualizado (${publicProducts.length} produtos)`, 'api-success');
                    
                    // Abrir site principal em nova aba para verifica√ß√£o
                    setTimeout(() => {
                        const verify = confirm(`Site principal atualizado com ${publicProducts.length} produtos.\n\nAbrir agora?`);
                        if (verify) {
                            const siteWindow = window.open('/', '_blank');
                            if (siteWindow) {
                                // Enviar mensagem para recarregar produtos
                                setTimeout(() => {
                                    siteWindow.postMessage({ type: 'forceReloadProducts' }, '*');
                                }, 1000);
                            }
                        }
                    }, 1000);
                } else {
                    showRealTimeStatus('‚ö†Ô∏è API p√∫blica n√£o retornou produtos', 'api-warning');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao for√ßar atualiza√ß√£o:', error);
                showRealTimeStatus('‚ùå Erro ao atualizar site', 'api-error');
            }
        }

        // ========== FUN√á√ïES AUXILIARES ==========
        function checkUnsavedChanges() {
            // Verificar se h√° produtos n√£o sincronizados
            const localProducts = JSON.parse(localStorage.getItem('romanelProducts') || '[]');
            unsavedChanges = localProducts.length > products.length;
            
            if (unsavedChanges) {
                document.getElementById('sync-badge').style.display = 'flex';
            } else {
                document.getElementById('sync-badge').style.display = 'none';
            }
        }

        // ========== MANTENDO AS OUTRAS FUN√á√ïES EXISTENTES ==========
        function loadData() {
            try {
                // Primeiro tenta carregar da API
                fetchProductsFromAPI().then(apiSuccess => {
                    if (!apiSuccess) {
                        // Se falhar, carrega do localStorage
                        const storedProducts = localStorage.getItem('romanelProducts');
                        if (storedProducts) {
                            products = JSON.parse(storedProducts);
                        } else {
                            products = [];
                        }
                    }

                    // Carregar pedidos
                    const storedOrders = localStorage.getItem('romanelOrders');
                    if (storedOrders) {
                        orders = JSON.parse(storedOrders);
                    } else {
                        orders = [];
                    }

                    // Carregar reembolsos
                    const storedRefunds = localStorage.getItem('romanelRefunds');
                    if (storedRefunds) {
                        refunds = JSON.parse(storedRefunds);
                    } else {
                        refunds = [];
                    }

                    // Carregar notifica√ß√µes
                    const storedNotifications = localStorage.getItem('romanelRefundNotifications');
                    if (storedNotifications) {
                        notifications = JSON.parse(storedNotifications);
                    } else {
                        notifications = [];
                    }

                    console.log('Dados carregados:', { 
                        products: products.length, 
                        orders: orders.length, 
                        refunds: refunds.length, 
                        notifications: notifications.length 
                    });

                    // Atualizar interfaces
                    updateDashboard();
                    renderProducts();
                    renderOrders();
                    renderRefunds();
                    renderNotifications();

                }).catch(error => {
                    console.error('Erro ao carregar dados:', error);
                    showAlert('Erro ao carregar dados do sistema', 'danger');
                });

            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showAlert('Erro ao carregar dados do sistema', 'danger');
            }
        }

        function saveData() {
            try {
                localStorage.setItem('romanelProducts', JSON.stringify(products));
                localStorage.setItem('romanelOrders', JSON.stringify(orders));
                localStorage.setItem('romanelRefunds', JSON.stringify(refunds));
                localStorage.setItem('romanelRefundNotifications', JSON.stringify(notifications));
                console.log('‚úÖ Dados salvos no localStorage');
            } catch (error) {
                console.error('‚ùå Erro ao salvar dados:', error);
                showAlert('Erro ao salvar dados', 'danger');
            }
        }

        // ========== NAVEGA√á√ÉO ==========
        function showSection(sectionId) {
            // Esconder todas as se√ß√µes
            document.querySelectorAll('.admin-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remover classe active de todos os bot√µes
            document.querySelectorAll('.admin-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar se√ß√£o selecionada
            const section = document.getElementById(sectionId + '-section');
            if (section) {
                section.classList.add('active');
            }
            
            // Ativar bot√£o correspondente
            const activeBtn = Array.from(document.querySelectorAll('.admin-nav-btn')).find(btn => 
                btn.textContent.includes(getSectionIcon(sectionId))
            );
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            // Atualizar dados da se√ß√£o
            switch(sectionId) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'products':
                    renderProducts();
                    break;
                case 'orders':
                    renderOrders();
                    break;
                case 'refunds':
                    updateRefundStats();
                    renderRefunds();
                    break;
                case 'notifications':
                    renderNotifications();
                    break;
            }
        }

        function getSectionIcon(sectionId) {
            const icons = {
                'dashboard': 'üìä',
                'products': 'üõçÔ∏è',
                'orders': 'üì¶',
                'refunds': 'üí∞',
                'notifications': 'üîî',
                'settings': '‚öôÔ∏è'
            };
            return icons[sectionId] || 'üìã';
        }

        // ========== DASHBOARD ==========
        function updateDashboard() {
            // Atualizar estat√≠sticas
            document.getElementById('total-products').textContent = products.length;
            document.getElementById('total-orders').textContent = orders.length;
            document.getElementById('pending-orders').textContent = orders.filter(o => 
                ['received', 'approved', 'preparing'].includes(o.status)
            ).length;
            document.getElementById('pending-refunds').textContent = refunds.filter(r => 
                r.status === refundStatuses.PENDING
            ).length;
            document.getElementById('total-revenue').textContent = formatCurrency(
                orders.filter(o => o.status === 'delivered').reduce((sum, o) => sum + o.total, 0)
            );
            document.getElementById('today-orders').textContent = orders.filter(o => 
                new Date(o.createdAt).toDateString() === new Date().toDateString()
            ).length;

            // Atualizar estat√≠sticas recentes
            updateRecentStats();
        }

        function updateRecentStats() {
            const statsContainer = document.getElementById('recent-stats');
            if (!statsContainer) return;

            const today = new Date();
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                last7Days.push(date.toISOString().split('T')[0]);
            }

            const ordersByDate = {};
            const revenueByDate = {};

            last7Days.forEach(date => {
                ordersByDate[date] = 0;
                revenueByDate[date] = 0;
            });

            orders.forEach(order => {
                const orderDate = order.createdAt.split('T')[0];
                if (ordersByDate[orderDate] !== undefined) {
                    ordersByDate[orderDate]++;
                    revenueByDate[orderDate] += order.total;
                }
            });

            let statsHTML = '<div style="max-height: 200px; overflow-y: auto;">';
            last7Days.forEach(date => {
                const dateFormatted = new Date(date).toLocaleDateString('pt-BR');
                statsHTML += `
                    <div style="border-bottom: 1px solid #eee; padding: 5px 0;">
                        <strong>${dateFormatted}:</strong> ${ordersByDate[date]} pedidos, 
                        ${formatCurrency(revenueByDate[date])}
                    </div>
                `;
            });
            statsHTML += '</div>';

            statsContainer.innerHTML = statsHTML;
        }

        function updateCurrentTime() {
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                const now = new Date();
                timeElement.textContent = now.toLocaleString('pt-BR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        }

        // ========== PRODUTOS ==========
        function showAddProductForm() {
            document.getElementById('add-product-form').classList.remove('d-none');
            document.getElementById('product-form').reset();
            document.getElementById('sale-fields').classList.add('d-none');
            
            // Definir comportamento padr√£o para novo produto
            const form = document.getElementById('product-form');
            form.onsubmit = function(e) {
                e.preventDefault();
                saveProduct(e);
            };
            
            // Alterar texto do bot√£o
            form.querySelector('button[type="submit"]').textContent = 'üíæ Salvar Produto';
        }

        function hideAddProductForm() {
            document.getElementById('add-product-form').classList.add('d-none');
        }

        function toggleSaleFields() {
            const saleFields = document.getElementById('sale-fields');
            const onSaleCheckbox = document.getElementById('product-on-sale');
            saleFields.classList.toggle('d-none', !onSaleCheckbox.checked);
        }

        function setProductFilter(filter) {
            currentProductFilter = filter;
            
            // Atualizar bot√µes
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            event.target.classList.add('active');
            
            renderProducts();
        }

        function filterProducts() {
            const searchTerm = document.getElementById('product-search').value.toLowerCase();
            const categoryFilter = document.getElementById('category-filter').value;
            
            const filteredProducts = products.filter(product => {
                // Busca por termo
                const matchesSearch = searchTerm === '' || 
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.code.toLowerCase().includes(searchTerm) ||
                    product.category.toLowerCase().includes(searchTerm);
                
                // Filtro por categoria
                const matchesCategory = categoryFilter === '' || product.category === categoryFilter;
                
                // Filtro personalizado
                let matchesCustomFilter = true;
                switch(currentProductFilter) {
                    case 'sale':
                        matchesCustomFilter = product.onSale;
                        break;
                    case 'low-stock':
                        matchesCustomFilter = product.stock < 5;
                        break;
                }
                
                return matchesSearch && matchesCategory && matchesCustomFilter;
            });
            
            renderProducts(filteredProducts);
        }

        function renderProducts(filteredProducts = products) {
            const container = document.getElementById('products-container');
            if (!container) return;
            
            if (filteredProducts.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-3">
                        <p class="text-muted">Nenhum produto encontrado</p>
                        <button class="btn btn-success mt-2" onclick="showAddProductForm()">
                            ‚ûï Adicionar Primeiro Produto
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredProducts.map(product => `
                <div class="product-card">
                    <img src="${product.image}" alt="${product.name}" class="product-image"
                         onerror="this.src='https://via.placeholder.com/300x200?text=Produto'">
                    <div class="product-info">
                        <h4 class="product-title">${product.name}</h4>
                        <p class="text-muted" style="font-size: 12px;">C√≥digo: ${product.code}</p>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span class="product-price">
                                ${product.onSale ? `
                                    <span style="text-decoration: line-through; color: #999; margin-right: 5px;">
                                        ${formatCurrency(product.originalPrice)}
                                    </span>
                                    ${formatCurrency(product.price)}
                                    <span style="color: #e74c3c; font-size: 12px; margin-left: 5px;">
                                        ${product.discountPercentage}% OFF
                                    </span>
                                ` : formatCurrency(product.price)}
                            </span>
                            <span class="gender-badge gender-${product.gender}" style="padding: 3px 8px; background: #f0f0f0; border-radius: 4px; font-size: 12px;">
                                ${getGenderName(product.gender)}
                            </span>
                        </div>
                        
                        <p style="font-size: 12px; color: #666;">
                            <strong>Categoria:</strong> ${getCategoryName(product.category)}<br>
                            <strong>Cor:</strong> ${product.color}<br>
                            <strong>Estoque:</strong> ${product.stock} unidades
                        </p>
                        
                        <div class="action-buttons mt-3">
                            <button class="btn btn-sm btn-warning" onclick="editProduct(${product.id})">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})">
                                üóëÔ∏è Excluir
                            </button>
                            <button class="btn btn-sm btn-info" onclick="viewProductDetails(${product.id})">
                                üëÅÔ∏è Ver
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="testProductOnSite(${product.id})">
                                üåê Testar no Site
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function testProductOnSite(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            console.log(`üåê Testando produto ${product.code} no site principal...`);
            
            // Abrir site principal em nova aba
            const siteWindow = window.open('/', '_blank');
            
            // Depois que a janela carregar, verificar se o produto est√° l√°
            setTimeout(() => {
                if (siteWindow) {
                    // Enviar mensagem para a janela principal recarregar produtos
                    siteWindow.postMessage({ 
                        type: 'reloadProducts',
                        productCode: product.code 
                    }, '*');
                    
                    showAlert(`üåê Site principal aberto. Verifique se o produto "${product.name}" aparece na lista.`, 'info');
                }
            }, 2000);
        }

        function viewProductDetails(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            alert(`
üì¶ Detalhes do Produto #${product.id}

Nome: ${product.name}
C√≥digo: ${product.code}
Pre√ßo: ${formatCurrency(product.price)}
${product.onSale ? `Pre√ßo Original: ${formatCurrency(product.originalPrice)} (${product.discountPercentage}% OFF)` : ''}
Categoria: ${getCategoryName(product.category)}
G√™nero: ${getGenderName(product.gender)}
Cor: ${product.color}
Estoque: ${product.stock} unidades
Descri√ß√£o: ${product.description || 'Nenhuma'}
Caracter√≠sticas: ${product.features ? product.features.join(', ') : 'Nenhuma'}
Tamanhos: ${product.sizes ? product.sizes.map(s => s.size).join(', ') : '√önico'}
Data de cria√ß√£o: ${new Date(product.createdAt).toLocaleString('pt-BR')}
√öltima atualiza√ß√£o: ${new Date(product.updatedAt).toLocaleString('pt-BR')}
            `);
        }

        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            showAddProductForm();
            
            // Preencher formul√°rio
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-code').value = product.code;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-category').value = product.category;
            document.getElementById('product-color').value = product.color;
            document.getElementById('product-gender').value = product.gender;
            document.getElementById('product-stock').value = product.stock;
            document.getElementById('product-image').value = product.image;
            document.getElementById('product-description').value = product.description || '';
            document.getElementById('product-features').value = product.features ? product.features.join('\n') : '';
            document.getElementById('product-sizes').value = product.sizes ? 
                product.sizes.map(s => s.size).join(', ') : '';
            
            // Preencher campos de promo√ß√£o
            document.getElementById('product-on-sale').checked = product.onSale;
            if (product.onSale) {
                document.getElementById('original-price').value = product.originalPrice;
                document.getElementById('discount-percentage').value = product.discountPercentage;
                document.getElementById('sale-fields').classList.remove('d-none');
            }
            
            // Alterar comportamento do formul√°rio para edi√ß√£o
            const form = document.getElementById('product-form');
            form.onsubmit = async function(e) {
                e.preventDefault();
                await updateProduct(productId);
            };
            
            // Alterar texto do bot√£o
            form.querySelector('button[type="submit"]').textContent = 'üíæ Atualizar Produto';
        }

        // ========== PEDIDOS ==========
        function filterOrders() {
            currentOrderStatusFilter = document.getElementById('order-status-filter').value;
            renderOrders();
        }

        function renderOrders() {
            const tbody = document.getElementById('orders-table-body');
            if (!tbody) return;
            
            let filteredOrders = orders;
            
            // Aplicar filtro de status
            if (currentOrderStatusFilter) {
                filteredOrders = orders.filter(order => order.status === currentOrderStatusFilter);
            }
            
            // Ordenar por data (mais recentes primeiro)
            filteredOrders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            if (filteredOrders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            Nenhum pedido encontrado
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = filteredOrders.map(order => `
                <tr>
                    <td>#${order.id}</td>
                    <td>
                        <strong>${order.customer.name}</strong><br>
                        <small>${order.customer.email}</small>
                    </td>
                    <td>
                        <small>
                            ${order.items.map(item => 
                                `${item.name} (x${item.quantity})`
                            ).join('<br>')}
                        </small>
                    </td>
                    <td>${formatCurrency(order.total)}</td>
                    <td>
                        <span class="status-badge status-${order.status}">
                            ${getStatusLabel(order.status)}
                        </span>
                    </td>
                    <td>
                        ${new Date(order.createdAt).toLocaleDateString('pt-BR')}<br>
                        <small>${new Date(order.createdAt).toLocaleTimeString('pt-BR')}</small>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-info" onclick="viewOrderDetails(${order.id})">
                                üëÅÔ∏è Ver
                            </button>
                            <button class="btn btn-sm btn-success" onclick="updateOrderStatus(${order.id})"
                                    ${order.status === 'delivered' || order.status === 'cancelled' ? 'disabled' : ''}>
                                ‚è≠Ô∏è Avan√ßar
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="cancelOrder(${order.id})"
                                    ${order.status === 'delivered' || order.status === 'cancelled' ? 'disabled' : ''}>
                                ‚ùå Cancelar
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function viewOrderDetails(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            const modal = document.getElementById('order-details-modal');
            const content = document.getElementById('order-details-content');
            
            // Verificar se h√° reembolso associado
            const orderRefunds = refunds.filter(r => r.orderId === orderId);
            const hasRefund = orderRefunds.length > 0;
            const latestRefund = hasRefund ? 
                orderRefunds.reduce((latest, refund) => {
                    return new Date(refund.requestedAt) > new Date(latest.requestedAt) ? refund : latest;
                }, orderRefunds[0]) : null;
            
            content.innerHTML = `
                <div class="form-section">
                    <h4>üìã Informa√ß√µes do Pedido</h4>
                    <p><strong>ID:</strong> #${order.id}</p>
                    <p><strong>Cliente:</strong> ${order.customer.name}</p>
                    <p><strong>E-mail:</strong> ${order.customer.email}</p>
                    <p><strong>Telefone:</strong> ${order.customer.phone}</p>
                    <p><strong>Data:</strong> ${new Date(order.createdAt).toLocaleString('pt-BR')}</p>
                    <p><strong>Status:</strong> <span class="status-badge status-${order.status}">${getStatusLabel(order.status)}</span></p>
                    <p><strong>Total:</strong> ${formatCurrency(order.total)}</p>
                </div>
                
                <div class="form-section">
                    <h4>üè† Endere√ßo de Entrega</h4>
                    <p>${order.customer.address.street}, ${order.customer.address.number}</p>
                    ${order.customer.address.complement ? `<p>${order.customer.address.complement}</p>` : ''}
                    <p>${order.customer.address.city} - ${order.customer.address.state}</p>
                    <p>CEP: ${order.customer.address.zipCode}</p>
                </div>
                
                <div class="form-section">
                    <h4>üõçÔ∏è Itens do Pedido</h4>
                    <table class="admin-table" style="font-size: 14px;">
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>C√≥digo</th>
                                <th>Pre√ßo</th>
                                <th>Quantidade</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.items.map(item => `
                                <tr>
                                    <td>${item.name} ${item.selectedSize ? `(${item.selectedSize})` : ''}</td>
                                    <td>${item.code}</td>
                                    <td>${formatCurrency(item.price)}</td>
                                    <td>${item.quantity}</td>
                                    <td>${formatCurrency(item.price * item.quantity)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" style="text-align: right;"><strong>Total:</strong></td>
                                <td><strong>${formatCurrency(order.total)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                ${renderOrderTimeline(order)}
                
                ${hasRefund ? renderRefundDetailsInModal(latestRefund) : ''}
                
                ${order.status === 'preparing' ? renderPreparationDetails(order) : ''}
                
                <div class="action-buttons mt-3">
                    <button class="btn btn-success" onclick="updateOrderStatus(${order.id})"
                            ${order.status === 'delivered' || order.status === 'cancelled' ? 'disabled' : ''}>
                        ‚è≠Ô∏è Avan√ßar Status
                    </button>
                    <button class="btn btn-danger" onclick="cancelOrder(${order.id})"
                            ${order.status === 'delivered' || order.status === 'cancelled' ? 'disabled' : ''}>
                        ‚ùå Cancelar Pedido
                    </button>
                    ${order.status === 'approved' ? `
                        <button class="btn btn-warning" onclick="startPreparation(${order.id})">
                            üîß Iniciar Prepara√ß√£o
                        </button>
                    ` : ''}
                    ${order.status === 'preparing' ? `
                        <button class="btn btn-success" onclick="completePreparation(${order.id})">
                            ‚úÖ Finalizar Prepara√ß√£o
                        </button>
                    ` : ''}
                    ${(order.status === 'delivered' || order.status === 'cancelled') ? `
                        <button class="btn btn-warning" onclick="deleteOrder(${order.id})">
                            üóëÔ∏è Excluir Pedido
                        </button>
                    ` : ''}
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        function renderOrderTimeline(order) {
            const currentStatusIndex = orderStatuses.findIndex(s => s.key === order.status);
            
            return `
                <div class="form-section">
                    <h4>üìä Timeline do Pedido</h4>
                    <div class="status-timeline">
                        ${orderStatuses.map((status, index) => {
                            let stepClass = '';
                            let dateText = '';
                            
                            if (order.status === 'cancelled') {
                                stepClass = 'cancelled';
                            } else {
                                if (status.key === 'delivered' && order.status === 'delivered') {
                                    stepClass = 'completed';
                                } else if (index < currentStatusIndex) {
                                    stepClass = 'completed';
                                } else if (index === currentStatusIndex) {
                                    stepClass = 'active';
                                }
                            }
                            
                            // Buscar data do status no hist√≥rico
                            const statusEntry = order.statusHistory ? 
                                order.statusHistory.find(entry => entry.status === status.key) : null;
                            if (statusEntry) {
                                dateText = `<div style="font-size: 9px; margin-top: 2px;">${new Date(statusEntry.date).toLocaleDateString('pt-BR')}</div>`;
                            }
                            
                            return `
                                <div class="status-step ${stepClass}">
                                    <div class="status-icon">${status.icon}</div>
                                    <div class="status-label">${status.label}</div>
                                    ${dateText}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderRefundDetailsInModal(refund) {
            return `
                <div class="form-section" style="background-color: #fff3cd;">
                    <h4>üí∞ Solicita√ß√£o de Reembolso</h4>
                    <p><strong>Status:</strong> <span class="refund-status refund-${refund.status}">${getRefundStatusLabel(refund.status)}</span></p>
                    <p><strong>Motivo:</strong> ${refund.reason}</p>
                    <p><strong>Valor:</strong> ${formatCurrency(refund.amount)}</p>
                    <p><strong>Solicitado em:</strong> ${new Date(refund.requestedAt).toLocaleString('pt-BR')}</p>
                    
                    <div class="action-buttons mt-2">
                        ${refund.status === refundStatuses.PENDING ? `
                            <button class="btn btn-sm btn-success" onclick="updateRefundStatusInModal(${refund.id}, '${refundStatuses.APPROVED}')">
                                ‚úÖ Aprovar
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="updateRefundStatusInModal(${refund.id}, '${refundStatuses.REJECTED}')">
                                ‚ùå Rejeitar
                            </button>
                        ` : ''}
                        ${refund.status === refundStatuses.APPROVED ? `
                            <button class="btn btn-sm btn-info" onclick="updateRefundStatusInModal(${refund.id}, '${refundStatuses.PROCESSING}')">
                                üîÑ Processar
                            </button>
                        ` : ''}
                        ${refund.status === refundStatuses.PROCESSING ? `
                            <button class="btn btn-sm btn-success" onclick="updateRefundStatusInModal(${refund.id}, '${refundStatuses.COMPLETED}')">
                                ‚úÖ Concluir
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderPreparationDetails(order) {
            if (!order.preparation) {
                order.preparation = {
                    startedAt: new Date().toISOString(),
                    items: order.items.map(item => ({
                        id: item.id,
                        name: item.name,
                        code: item.code,
                        quantity: item.quantity,
                        prepared: false
                    })),
                    notes: ''
                };
            }
            
            const startTime = new Date(order.preparation.startedAt);
            const now = new Date();
            const diffMs = now - startTime;
            const diffMins = Math.floor(diffMs / 60000);
            
            return `
                <div class="form-section">
                    <h4>üîß Prepara√ß√£o do Pedido</h4>
                    <p><strong>Tempo decorrido:</strong> ${diffMins} minutos</p>
                    
                    <div class="preparation-items">
                        <h5>Itens para preparar:</h5>
                        ${order.preparation.items.map(item => `
                            <div class="preparation-item">
                                <div>
                                    <input type="checkbox" class="item-checkbox" ${item.prepared ? 'checked' : ''} 
                                           onchange="toggleItemPreparation(${order.id}, ${item.id})">
                                    <span>${item.name} (C√≥d. ${item.code}) x${item.quantity}</span>
                                </div>
                                <span style="font-size: 12px; color: ${item.prepared ? '#27ae60' : '#e74c3c'}">
                                    ${item.prepared ? '‚úì Preparado' : 'Pendente'}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="form-group mt-3">
                        <label for="preparation-notes-${order.id}">Observa√ß√µes:</label>
                        <textarea id="preparation-notes-${order.id}" rows="2" onchange="updatePreparationNotes(${order.id}, this.value)"
                                  style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">${order.preparation.notes || ''}</textarea>
                    </div>
                </div>
            `;
        }

        function closeOrderModal() {
            document.getElementById('order-details-modal').style.display = 'none';
        }

        function updateOrderStatus(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            // Determinar pr√≥ximo status
            const currentStatusIndex = orderStatuses.findIndex(s => s.key === order.status);
            let nextStatus;
            
            if (currentStatusIndex < orderStatuses.length - 1) {
                nextStatus = orderStatuses[currentStatusIndex + 1].key;
            } else {
                nextStatus = 'delivered'; // √öltimo status
            }
            
            // Atualizar status
            order.status = nextStatus;
            order.updatedAt = new Date().toISOString();
            
            // Inicializar statusHistory se n√£o existir
            if (!order.statusHistory) {
                order.statusHistory = [];
            }
            
            // Adicionar ao hist√≥rico
            order.statusHistory.push({
                status: nextStatus,
                date: new Date().toISOString()
            });
            
            // Se status for 'preparando', iniciar prepara√ß√£o
            if (nextStatus === 'preparing') {
                startPreparation(orderId);
            }
            
            // Salvar e atualizar
            saveData();
            renderOrders();
            updateDashboard();
            
            showAlert(`Status do pedido #${orderId} atualizado para: ${getStatusLabel(nextStatus)}`, 'success');
            closeOrderModal();
        }

        function cancelOrder(orderId) {
            showConfirmation(
                'Cancelar Pedido',
                'Tem certeza que deseja cancelar este pedido? Esta a√ß√£o n√£o pode ser desfeita.',
                function() {
                    const order = orders.find(o => o.id === orderId);
                    if (!order) return;
                    
                    // Verificar se o pedido pode ser cancelado
                    if (order.status === 'shipped' || order.status === 'delivered') {
                        showAlert('Este pedido n√£o pode ser cancelado porque j√° foi enviado ou entregue.', 'danger');
                        return;
                    }
                    
                    // Atualizar status para cancelado
                    order.status = 'cancelled';
                    order.updatedAt = new Date().toISOString();
                    
                    // Inicializar statusHistory se n√£o existir
                    if (!order.statusHistory) {
                        order.statusHistory = [];
                    }
                    
                    // Adicionar ao hist√≥rico
                    order.statusHistory.push({
                        status: 'cancelled',
                        date: new Date().toISOString()
                    });
                    
                    // Salvar e atualizar
                    saveData();
                    renderOrders();
                    updateDashboard();
                    
                    showAlert(`Pedido #${orderId} cancelado com sucesso.`, 'success');
                    closeOrderModal();
                }
            );
        }

        function startPreparation(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            // Atualizar status para "preparando"
            order.status = 'preparing';
            order.updatedAt = new Date().toISOString();
            
            // Inicializar dados de prepara√ß√£o
            order.preparation = {
                startedAt: new Date().toISOString(),
                items: order.items.map(item => ({
                    id: item.id,
                    name: item.name,
                    code: item.code,
                    quantity: item.quantity,
                    prepared: false
                })),
                notes: ''
            };
            
            // Salvar e atualizar
            saveData();
            renderOrders();
            
            showAlert(`Prepara√ß√£o do pedido #${orderId} iniciada!`, 'success');
        }

        function toggleItemPreparation(orderId, itemId) {
            const order = orders.find(o => o.id === orderId);
            if (!order || !order.preparation) return;
            
            const item = order.preparation.items.find(i => i.id === itemId);
            if (!item) return;
            
            item.prepared = !item.prepared;
            
            // Salvar altera√ß√µes
            saveData();
        }

        function updatePreparationNotes(orderId, notes) {
            const order = orders.find(o => o.id === orderId);
            if (!order || !order.preparation) return;
            
            order.preparation.notes = notes;
            
            // Salvar altera√ß√µes
            saveData();
        }

        function completePreparation(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order || !order.preparation) return;
            
            // Verificar se todos os itens foram preparados
            const allItemsPrepared = order.preparation.items.every(item => item.prepared);
            
            if (!allItemsPrepared) {
                showConfirmation(
                    'Finalizar Prepara√ß√£o',
                    'Nem todos os itens foram marcados como preparados. Deseja finalizar mesmo assim?',
                    function() {
                        finalizePreparation(orderId);
                    }
                );
            } else {
                finalizePreparation(orderId);
            }
        }

        function finalizePreparation(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order || !order.preparation) return;
            
            // Atualizar status para "pronto para entrega"
            order.status = 'ready';
            order.updatedAt = new Date().toISOString();
            
            // Calcular tempo total de prepara√ß√£o
            const startTime = new Date(order.preparation.startedAt);
            const endTime = new Date();
            const diffMs = endTime - startTime;
            const diffMins = Math.floor(diffMs / 60000);
            
            order.preparation.completedAt = endTime.toISOString();
            order.preparation.totalTime = diffMins;
            
            // Salvar e atualizar
            saveData();
            renderOrders();
            
            showAlert(`Prepara√ß√£o do pedido #${orderId} finalizada em ${diffMins} minutos!`, 'success');
            closeOrderModal();
        }

        function deleteOrder(orderId) {
            showConfirmation(
                'Excluir Pedido',
                'Tem certeza que deseja excluir este pedido? Esta a√ß√£o n√£o pode ser desfeita.',
                function() {
                    // Remover pedido
                    orders = orders.filter(order => order.id !== orderId);
                    
                    // Remover reembolsos associados
                    refunds = refunds.filter(refund => refund.orderId !== orderId);
                    
                    // Salvar e atualizar
                    saveData();
                    renderOrders();
                    updateDashboard();
                    
                    showAlert('Pedido exclu√≠do com sucesso!', 'success');
                    closeOrderModal();
                }
            );
        }

        function exportOrders() {
            const data = {
                orders: orders,
                exportDate: new Date().toISOString(),
                totalOrders: orders.length,
                totalRevenue: orders.filter(o => o.status === 'delivered').reduce((sum, o) => sum + o.total, 0)
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `pedidos-romanel-joias-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showAlert('Pedidos exportados com sucesso!', 'success');
        }

        // ========== REEMBOLSOS ==========
        function updateRefundStats() {
            document.getElementById('total-refunds').textContent = refunds.length;
            document.getElementById('pending-refunds-count').textContent = 
                refunds.filter(r => r.status === refundStatuses.PENDING).length;
            document.getElementById('approved-refunds').textContent = 
                refunds.filter(r => r.status === refundStatuses.APPROVED).length;
            document.getElementById('completed-refunds').textContent = 
                refunds.filter(r => r.status === refundStatuses.COMPLETED).length;
            document.getElementById('refunds-amount').textContent = formatCurrency(
                refunds.filter(r => r.status === refundStatuses.COMPLETED).reduce((sum, r) => sum + r.amount, 0)
            );
        }

        function filterRefunds() {
            currentRefundStatusFilter = document.getElementById('refund-status-filter').value;
            renderRefunds();
        }

        function renderRefunds() {
            const tbody = document.getElementById('refunds-table-body');
            if (!tbody) return;
            
            let filteredRefunds = refunds;
            
            // Aplicar filtro de status
            if (currentRefundStatusFilter) {
                filteredRefunds = refunds.filter(refund => refund.status === currentRefundStatusFilter);
            }
            
            // Ordenar por data (mais recentes primeiro)
            filteredRefunds.sort((a, b) => new Date(b.requestedAt) - new Date(a.requestedAt));
            
            if (filteredRefunds.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            Nenhum reembolso encontrado
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = filteredRefunds.map(refund => {
                const order = orders.find(o => o.id === refund.orderId);
                const customerName = order ? order.customer.name : 'N/A';
                
                return `
                    <tr>
                        <td>#${refund.id}</td>
                        <td>#${refund.orderId}</td>
                        <td>${customerName}</td>
                        <td>${truncateText(refund.reason, 30)}</td>
                        <td>${formatCurrency(refund.amount)}</td>
                        <td>
                            <span class="refund-status refund-${refund.status}">
                                ${getRefundStatusLabel(refund.status)}
                            </span>
                        </td>
                        <td>
                            ${new Date(refund.requestedAt).toLocaleDateString('pt-BR')}<br>
                            <small>${new Date(refund.requestedAt).toLocaleTimeString('pt-BR')}</small>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-info" onclick="viewRefundDetails(${refund.id})">
                                    üëÅÔ∏è Ver
                                </button>
                                ${refund.status === refundStatuses.PENDING ? `
                                    <button class="btn btn-sm btn-success" onclick="updateRefundStatusInList(${refund.id}, '${refundStatuses.APPROVED}')">
                                        ‚úÖ Aprovar
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="updateRefundStatusInList(${refund.id}, '${refundStatuses.REJECTED}')">
                                        ‚ùå Rejeitar
                                    </button>
                                ` : ''}
                                ${refund.status === refundStatuses.APPROVED ? `
                                    <button class="btn btn-sm btn-info" onclick="updateRefundStatusInList(${refund.id}, '${refundStatuses.PROCESSING}')">
                                        üîÑ Processar
                                    </button>
                                ` : ''}
                                ${refund.status === refundStatuses.PROCESSING ? `
                                    <button class="btn btn-sm btn-success" onclick="updateRefundStatusInList(${refund.id}, '${refundStatuses.COMPLETED}')">
                                        ‚úÖ Concluir
                                    </button>
                                ` : ''}
                                ${refund.status === refundStatuses.COMPLETED || refund.status === refundStatuses.REJECTED ? `
                                    <button class="btn btn-sm btn-warning" onclick="deleteRefund(${refund.id})">
                                        üóëÔ∏è Excluir
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateRefundStats();
        }

        function viewRefundDetails(refundId) {
            const refund = refunds.find(r => r.id === refundId);
            if (!refund) return;
            
            const order = orders.find(o => o.id === refund.orderId);
            
            alert(`
Detalhes do Reembolso #${refund.id}

Pedido: #${refund.orderId}
Cliente: ${order ? order.customer.name : 'N/A'}
E-mail: ${refund.customerEmail}
Status: ${getRefundStatusLabel(refund.status)}
Motivo: ${refund.reason}
Observa√ß√µes: ${refund.notes || 'Nenhuma'}
Valor: ${formatCurrency(refund.amount)}
Solicitado em: ${new Date(refund.requestedAt).toLocaleString('pt-BR')}
${refund.processedAt ? `Processado em: ${new Date(refund.processedAt).toLocaleString('pt-BR')}` : ''}
${refund.completedAt ? `Conclu√≠do em: ${new Date(refund.completedAt).toLocaleString('pt-BR')}` : ''}
${refund.adminNotes ? `Observa√ß√µes do admin: ${refund.adminNotes}` : ''}

Hist√≥rico:
${refund.history ? refund.history.map(h => 
    `‚Ä¢ ${new Date(h.date).toLocaleString('pt-BR')} - ${h.notes}`
).join('\n') : 'Nenhum hist√≥rico'}
            `);
        }

        function updateRefundStatusInModal(refundId, newStatus) {
            updateRefundStatus(refundId, newStatus);
            // Reabrir modal para mostrar atualiza√ß√µes
            const refund = refunds.find(r => r.id === refundId);
            if (refund) {
                const orderId = refund.orderId;
                closeOrderModal();
                setTimeout(() => viewOrderDetails(orderId), 100);
            }
        }

        function updateRefundStatusInList(refundId, newStatus) {
            updateRefundStatus(refundId, newStatus);
        }

        function updateRefundStatus(refundId, newStatus) {
            const refund = refunds.find(r => r.id === refundId);
            if (!refund) {
                showAlert('Reembolso n√£o encontrado.', 'danger');
                return;
            }
            
            let adminNotes = '';
            if (newStatus === refundStatuses.REJECTED) {
                adminNotes = prompt('Por favor, informe o motivo da rejei√ß√£o:');
                if (adminNotes === null) return; // Usu√°rio cancelou
            } else if (newStatus === refundStatuses.COMPLETED) {
                adminNotes = prompt('Por favor, informe observa√ß√µes sobre a conclus√£o do reembolso (opcional):');
                if (adminNotes === null) adminNotes = ''; // Usu√°rio cancelou, mas continua
            }
            
            // Atualizar status
            refund.status = newStatus;
            if (adminNotes) {
                refund.adminNotes = adminNotes;
            }
            
            // Inicializar history se n√£o existir
            if (!refund.history) {
                refund.history = [];
            }
            
            // Adicionar ao hist√≥rico
            refund.history.push({
                status: newStatus,
                date: new Date().toISOString(),
                notes: `Status alterado para: ${getRefundStatusLabel(newStatus)}` + 
                       (adminNotes ? ` - Observa√ß√µes: ${adminNotes}` : '')
            });
            
            // Atualizar datas relevantes
            if (newStatus === refundStatuses.APPROVED || newStatus === refundStatuses.REJECTED) {
                refund.processedAt = new Date().toISOString();
            }
            
            if (newStatus === refundStatuses.COMPLETED) {
                refund.completedAt = new Date().toISOString();
            }
            
            // Salvar altera√ß√µes
            saveData();
            
            // Atualizar interfaces
            renderRefunds();
            updateDashboard();
            
            showAlert(`Status do reembolso #${refundId} atualizado para: ${getRefundStatusLabel(newStatus)}`, 'success');
        }

        function deleteRefund(refundId) {
            showConfirmation(
                'Excluir Reembolso',
                'Tem certeza que deseja excluir este reembolso? Esta a√ß√£o n√£o pode ser desfeita.',
                function() {
                    refunds = refunds.filter(refund => refund.id !== refundId);
                    saveData();
                    renderRefunds();
                    updateDashboard();
                    showAlert('Reembolso exclu√≠do com sucesso!', 'success');
                }
            );
        }

        function cleanupRefunds() {
            showConfirmation(
                'Limpar Reembolsos Conclu√≠dos',
                'Esta a√ß√£o excluir√° todos os reembolsos com status "Conclu√≠do". Tem certeza?',
                function() {
                    const completedRefunds = refunds.filter(r => r.status === refundStatuses.COMPLETED);
                    refunds = refunds.filter(r => r.status !== refundStatuses.COMPLETED);
                    saveData();
                    renderRefunds();
                    updateDashboard();
                    showAlert(`${completedRefunds.length} reembolsos conclu√≠dos foram exclu√≠dos.`, 'success');
                }
            );
        }

        // ========== NOTIFICA√á√ïES ==========
        function renderNotifications() {
            const container = document.getElementById('notifications-list');
            if (!container) return;
            
            // Ordenar notifica√ß√µes por data (mais recentes primeiro)
            const sortedNotifications = [...notifications].sort((a, b) => 
                new Date(b.createdAt) - new Date(a.createdAt)
            );
            
            if (sortedNotifications.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-3">
                        <p class="text-muted">Nenhuma notifica√ß√£o</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = sortedNotifications.map(notification => `
                <div class="notification-item ${notification.viewed ? '' : 'new-notification'}" 
                     style="${notification.viewed ? 'opacity: 0.8;' : 'border-left-color: #f39c12;'}">
                    <div class="notification-header">
                        <div class="notification-title">
                            ${notification.viewed ? 'üîî' : 'üî¥'} ${notification.title || 'Nova Solicita√ß√£o de Reembolso'}
                        </div>
                        <div class="notification-date">
                            ${new Date(notification.createdAt).toLocaleDateString('pt-BR')}
                            ${new Date(notification.createdAt).toLocaleTimeString('pt-BR')}
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        ${notification.message || `
                            <p><strong>Cliente:</strong> ${notification.customerName}</p>
                            <p><strong>Pedido:</strong> #${notification.orderId}</p>
                            <p><strong>Valor:</strong> ${formatCurrency(notification.amount)}</p>
                            <p><strong>Motivo:</strong> ${notification.reason}</p>
                        `}
                    </div>
                    <div class="action-buttons mt-2">
                        ${!notification.viewed ? `
                            <button class="btn btn-sm btn-success" onclick="markNotificationAsViewed(${notification.id})">
                                ‚úÖ Marcar como Lida
                            </button>
                        ` : ''}
                        <button class="btn btn-sm btn-danger" onclick="deleteNotification(${notification.id})">
                            üóëÔ∏è Excluir
                        </button>
                        ${notification.refundId ? `
                            <button class="btn btn-sm btn-info" onclick="viewRefundDetails(${notification.refundId})">
                                üëÅÔ∏è Ver Reembolso
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function markNotificationAsViewed(notificationId) {
            const notification = notifications.find(n => n.id === notificationId);
            if (notification) {
                notification.viewed = true;
                saveData();
                renderNotifications();
            }
        }

        function deleteNotification(notificationId) {
            notifications = notifications.filter(n => n.id !== notificationId);
            saveData();
            renderNotifications();
            updateDashboard();
        }

        function refreshNotifications() {
            renderNotifications();
            showAlert('Notifica√ß√µes atualizadas!', 'success');
        }

        function clearAllNotifications() {
            showConfirmation(
                'Limpar Todas as Notifica√ß√µes',
                'Tem certeza que deseja excluir todas as notifica√ß√µes? Esta a√ß√£o n√£o pode ser desfeita.',
                function() {
                    notifications = [];
                    saveData();
                    renderNotifications();
                    updateDashboard();
                    showAlert('Todas as notifica√ß√µes foram exclu√≠das.', 'success');
                }
            );
        }

        // ========== CONFIGURA√á√ïES ==========
        function saveSettings() {
            if (!checkAdminAuthInFunction()) return;
            
            // Salvar configura√ß√µes (exemplo simplificado)
            const settings = {
                storeName: document.getElementById('store-name').value,
                storeEmail: document.getElementById('store-email').value,
                storePhone: document.getElementById('store-phone').value,
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem('romanelSettings', JSON.stringify(settings));
            showAlert('Configura√ß√µes salvas com sucesso!', 'success');
        }

        function changePassword() {
            if (!checkAdminAuthInFunction()) return;
            
            const newPassword = document.getElementById('admin-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (!newPassword || !confirmPassword) {
                showAlert('Preencha ambos os campos de senha.', 'warning');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showAlert('As senhas n√£o coincidem.', 'danger');
                return;
            }
            
            if (newPassword.length < 6) {
                showAlert('A senha deve ter pelo menos 6 caracteres.', 'warning');
                return;
            }
            
            // Aqui voc√™ implementaria a l√≥gica real de altera√ß√£o de senha
            // Por enquanto, vamos apenas mostrar uma mensagem
            showAlert('Senha alterada com sucesso!', 'success');
            
            // Limpar campos
            document.getElementById('admin-password').value = '';
            document.getElementById('confirm-password').value = '';
        }

        function backupData() {
            if (!checkAdminAuthInFunction()) return;
            
            const backup = {
                products: products,
                orders: orders,
                refunds: refunds,
                notifications: notifications,
                backupDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `backup-romanel-joias-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showAlert('Backup realizado com sucesso!', 'success');
        }

        function cleanupDeliveredOrders() {
            if (!checkAdminAuthInFunction()) return;
            
            showConfirmation(
                'Limpar Pedidos Entregues',
                'Esta a√ß√£o excluir√° todos os pedidos com status "Entregue". Tem certeza?',
                function() {
                    const deliveredOrders = orders.filter(o => o.status === 'delivered');
                    orders = orders.filter(o => o.status !== 'delivered');
                    saveData();
                    renderOrders();
                    updateDashboard();
                    showAlert(`${deliveredOrders.length} pedidos entregues foram exclu√≠dos.`, 'success');
                }
            );
        }

        function cleanupCancelledOrders() {
            if (!checkAdminAuthInFunction()) return;
            
            showConfirmation(
                'Limpar Pedidos Cancelados',
                'Esta a√ß√£o excluir√° todos os pedidos com status "Cancelado". Tem certeza?',
                function() {
                    const cancelledOrders = orders.filter(o => o.status === 'cancelled');
                    orders = orders.filter(o => o.status !== 'cancelled');
                    saveData();
                    renderOrders();
                    updateDashboard();
                    showAlert(`${cancelledOrders.length} pedidos cancelados foram exclu√≠dos.`, 'success');
                }
            );
        }

        function cleanupOldRefunds() {
            if (!checkAdminAuthInFunction()) return;
            
            showConfirmation(
                'Limpar Reembolsos Antigos',
                'Esta a√ß√£o excluir√° todos os reembolsos conclu√≠dos h√° mais de 30 dias. Tem certeza?',
                function() {
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    
                    const oldRefunds = refunds.filter(r => 
                        r.status === refundStatuses.COMPLETED && 
                        new Date(r.completedAt) < thirtyDaysAgo
                    );
                    
                    refunds = refunds.filter(r => 
                        !(r.status === refundStatuses.COMPLETED && 
                          new Date(r.completedAt) < thirtyDaysAgo)
                    );
                    
                    saveData();
                    renderRefunds();
                    updateDashboard();
                    showAlert(`${oldRefunds.length} reembolsos antigos foram exclu√≠dos.`, 'success');
                }
            );
        }

        // ========== UTILIT√ÅRIOS ==========
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function getStatusLabel(status) {
            const statusMap = {
                'received': 'Recebido',
                'approved': 'Aprovado',
                'preparing': 'Preparando',
                'ready': 'Pronto',
                'shipped': 'Enviado',
                'delivered': 'Entregue',
                'cancelled': 'Cancelado'
            };
            return statusMap[status] || status;
        }

        function getRefundStatusLabel(status) {
            const statusMap = {
                'pending': 'Pendente',
                'approved': 'Aprovado',
                'rejected': 'Rejeitado',
                'processing': 'Processando',
                'completed': 'Conclu√≠do'
            };
            return statusMap[status] || status;
        }

        function getCategoryName(categoryKey) {
            const categories = {
                'aneis': 'An√©is',
                'colares': 'Colares',
                'brincos': 'Brincos',
                'pulseiras': 'Pulseiras',
                'pingentes': 'Pingentes',
                'relogios': 'Rel√≥gios',
                'solitarios': 'Solit√°rios',
                'pet': 'Pet',
                'chaveiros': 'Chaveiros',
                'aliancas': 'Alian√ßas',
                'correntes': 'Correntes',
                'promocoes': 'Promo√ß√µes'
            };
            return categories[categoryKey] || categoryKey;
        }

        function getGenderName(genderKey) {
            const genders = {
                'feminino': 'Feminino',
                'masculino': 'Masculino',
                'infantil': 'Infantil',
                'unissex': 'Unissex'
            };
            return genders[genderKey] || genderKey;
        }

        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        // ========== MODAIS E ALERTAS ==========
        function showAlert(message, type = 'info') {
            // Criar elemento de alerta
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 15px; border-radius: 4px; background-color: ${getAlertColor(type)}; color: white;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; font-size: 20px; cursor: pointer; color: inherit;">
                        &times;
                    </button>
                </div>
            `;
            
            // Adicionar ao topo do container
            const container = document.querySelector('.admin-container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Remover automaticamente ap√≥s 5 segundos
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function getAlertColor(type) {
            const colors = {
                'success': '#28a745',
                'danger': '#dc3545',
                'warning': '#ffc107',
                'info': '#17a2b8'
            };
            return colors[type] || '#17a2b8';
        }

        function showConfirmation(title, message, confirmCallback) {
            const modal = document.getElementById('confirmation-modal');
            const titleElement = document.getElementById('confirmation-title');
            const messageElement = document.getElementById('confirmation-message');
            const confirmButton = document.getElementById('confirm-action-btn');
            
            titleElement.textContent = title;
            messageElement.textContent = message;
            
            // Remover event listeners anteriores
            const newConfirmButton = confirmButton.cloneNode(true);
            confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
            
            // Adicionar novo event listener
            newConfirmButton.onclick = function() {
                confirmCallback();
                closeConfirmationModal();
            };
            
            modal.style.display = 'flex';
        }

        function closeConfirmationModal() {
            document.getElementById('confirmation-modal').style.display = 'none';
        }

        function showLoading(message = 'Processando...') {
            const overlay = document.getElementById('loading-overlay');
            const messageElement = document.getElementById('loading-message');
            
            messageElement.textContent = message;
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // ========== EXPORTA√á√ÉO ==========
        function exportData() {
            if (!checkAdminAuthInFunction()) return;
            
            const data = {
                products: products,
                orders: orders,
                refunds: refunds,
                exportDate: new Date().toISOString(),
                summary: {
                    totalProducts: products.length,
                    totalOrders: orders.length,
                    totalRefunds: refunds.length,
                    totalRevenue: orders.filter(o => o.status === 'delivered').reduce((sum, o) => sum + o.total, 0)
                }
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `romanel-joias-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showAlert('Dados exportados com sucesso!', 'success');
        }
    </script>
</body>
</html>